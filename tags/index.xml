<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Tags on Bruno Luiz Silva</title><link>https://brunoluiz.net/tags/</link><description>Recent content in Tags on Bruno Luiz Silva</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><atom:link href="https://brunoluiz.net/tags/index.xml" rel="self" type="application/rss+xml"/><item><title>ImageWand: privacy-first image conversion experiment with Golang &amp; WASM</title><link>https://brunoluiz.net/blog/2022/aug/imagewand-privacy-first-image-conversion-experiment-with-golang-and-wasm/</link><pubDate>2022-08-07</pubDate><guid>https://brunoluiz.net/blog/2022/aug/imagewand-privacy-first-image-conversion-experiment-with-golang-and-wasm/</guid><description>&lt;p>&lt;a href="https://unsplash.com/photos/NbgQfUvKFE0">&lt;img loading="lazy" src="./cover.jpg" alt="Photo by Mark Tegethoff on Unsplash" />
&lt;/a>&lt;/p>
&lt;p>At the beginning of the year, I was curious about WebAssembly (WASM). &lt;a href="https://brunoluiz.net/blog/2022/jan/gif-sane-playback-control-ffmpegwasm/">The result was GIFSane&lt;/a>, but that was not enough: &lt;a href="https://github.com/ffmpegwasm/ffmpeg.wasm">FFMpeg.wasm&lt;/a> was already pre-compiled, and I only had to sort out how to use it within an extension. One thing was clear though: WASM shines when we think about complex applications (eg: media manipulation), usually performing better or opening more opportunities than JavaScript.&lt;/p>
&lt;p>I&amp;rsquo;ve moved houses quite recently. It meant manipulating tons of documents, converting to different formats, resizing etc. Mac&amp;rsquo;s Preview app can handle it, but many might rely on browsers due to the first search results for &amp;ldquo;Convert image format1 format2&amp;rdquo;. Seriously, look at these Google results.&lt;/p>
&lt;p>&lt;img loading="lazy" src="./01-google-search.png" alt="Google results for &amp;amp;lsquo;convert image&amp;amp;rsquo;" />
&lt;/p>
&lt;p>When someone is converting a puppy image from JPG to PDF this might be ok. But after hearing that my family used these sites to convert documents like Passports, I got scared. Most people don&amp;rsquo;t realise that these files go to a server, and they can be stored for whatever reason and for an indefinite time. &amp;ldquo;Identity theft&amp;rdquo; sends its regards ðŸ˜…&lt;/p>
&lt;p>What if there was some website to convert images locally, without requiring a server? What if the technology for that already exists? That is when I started developing &lt;a href="https://imagewand.concordalabs.com/">ImageWand&lt;/a> (&lt;a href="https://github.com/brunoluiz/imagewand">source&lt;/a>).&lt;/p>
&lt;h2 id="converting-your-images-locally-and-privately-imagewand">Converting your images locally and privately: ImageWand&lt;/h2>
&lt;p>ImageWand converts images locally using WASM and Golang. In the future, it could potentially resize and compress images, but I tried to keep it simple by only using standard libraries encoders and decoders (no PDF for now).&lt;/p>
&lt;p>It seems that Rust would have been a more solid choice for WASM, but I would have to learn it to develop this project. Rust is famous for its &lt;a href="https://users.rust-lang.org/t/making-rust-easy-to-learn-and-use/65866/3">steep learning curve&lt;/a> and, to keep things simple and focused, I went with Golang.&lt;/p>
&lt;p>&lt;img loading="lazy" src="./02-imagewand.png" alt="ImageWand main page" />
&lt;/p>
&lt;center>
&lt;small>Less is more, although I guess the application could benefit from more features ðŸ˜…&lt;/small>
&lt;/center>
&lt;h2 id="the-building-experience">The building experience&lt;/h2>
&lt;p>Golang offers some standard libraries for image manipulation (&lt;a href="https://pkg.go.dev/image">&lt;code>image&lt;/code> package&lt;/a>). Implementing something to convert A to B wasn&amp;rsquo;t the hard part. &lt;a href="https://github.com/brunoluiz/imagewand/blob/v1.0.0/imagewand.go">The conversion logic was extracted and re-used&lt;/a> in both CLI and WASM implementations, which is impressive in terms of portability.&lt;/p>
&lt;h3 id="covering-the-basics-interfacing-with-user-input">Covering the basics: interfacing with user input&lt;/h3>
&lt;p>In a CLI, the application can receive user input through flags or arguments. In WASM, things are a bit peculiar as inputs have to come from JavaScript into Golang.&lt;/p>
&lt;p>You can instantiate and load the WASM binary for every call, similar to a CLI call, but it would be an expensive operation. The best way is to run it in the background (&lt;a href="https://github.com/brunoluiz/imagewand/blob/v1.0.0/cmd/wasm/main.go#L54">observe the use of a channel to keep it running&lt;/a>) while developers call it through a JavaScript interface.&lt;/p>
&lt;p>In Golang, this is done by &lt;a href="https://github.com/brunoluiz/imagewand/blob/v1.0.0/cmd/wasm/main.go#L51-L53">exposing global JavaScript objects/functions within &lt;code>main()&lt;/code>&lt;/a>. It is not great as it might conflict with other variables and it pollutes the global scope. Other WASM implementations (Rust or TinyGo+WASI) &lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Instance/exports">expose methods by exporting them&lt;/a> in the WASM instance, which is cleaner than relying on global variables.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Println&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Starting ImageWand ðŸª„&amp;#34;&lt;/span>)
&lt;span style="color:#a6e22e">js&lt;/span>.&lt;span style="color:#a6e22e">Global&lt;/span>().&lt;span style="color:#a6e22e">Set&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;wand&amp;#34;&lt;/span>, &lt;span style="color:#66d9ef">map&lt;/span>[&lt;span style="color:#66d9ef">string&lt;/span>]&lt;span style="color:#66d9ef">interface&lt;/span>{}{
&lt;span style="color:#e6db74">&amp;#34;convertFromURL&amp;#34;&lt;/span>: &lt;span style="color:#a6e22e">convertFromURL&lt;/span>(),
&lt;span style="color:#e6db74">&amp;#34;convertFromBlob&amp;#34;&lt;/span>: &lt;span style="color:#a6e22e">convertFromBlob&lt;/span>(),
})
&lt;span style="color:#f92672">&amp;lt;-&lt;/span>make(&lt;span style="color:#66d9ef">chan&lt;/span> &lt;span style="color:#66d9ef">bool&lt;/span>)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="interacting-with-javascript-land">Interacting with &amp;ldquo;JavaScript-land&amp;rdquo;&lt;/h3>
&lt;p>To declare and interact with JavaScript in Golang runtime, developers rely on &lt;a href="https://pkg.go.dev/syscall/js">&lt;code>syscall/js&lt;/code>&lt;/a>. This package allows the application to create functions, read values from JS objects (DOM and non-DOM) and interface byte arrays with JS values (specifically: &lt;code>UInt8Array&lt;/code>). The only caveat is the following, been present since its release on Golang 1.11.&lt;/p>
&lt;blockquote>
&lt;p>&lt;em>This package is EXPERIMENTAL. Its current scope is only to allow tests to run, but not yet to provide a comprehensive API for users. It is exempt from the Go compatibility promise.&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;p>Although it allows all sorts of interactions with JavaScript, in my limited experience with it, I would recommend developers to only use it to interface user inputs between Golang and the JavaScript runtime.&lt;/p>
&lt;p>If you want to manipulate DOM or create elaborate objects through Golang, you might be in a world of pain. Not only there are no typing guarantees, but the tooling for those is just not there. ImageWand only uses it to gather user input to call &lt;code>imagewand&lt;/code> conversion functions, essentially a glue between the UI and Golang.&lt;/p>
&lt;p>I&amp;rsquo;ve &lt;a href="https://github.com/brunoluiz/imagewand/blob/main/jasm/wasm.go">created an internal package (jasm)&lt;/a> with a few helper functions to interface with JavaScript values. &lt;a href="https://github.com/brunoluiz/imagewand/blob/main/cmd/wasm/main.go#L20-L48">It made &lt;code>wasm/main.go&lt;/code> way cleaner&lt;/a>, but certainly the most important of all is the &lt;code>Await&lt;/code> method.&lt;/p>
&lt;h3 id="golang-and-javascript-promises">Golang and JavaScript promises&lt;/h3>
&lt;p>JavaScript applications are single-threaded and leverage an event-loop strategy. Certain tasks might cause it to block, such as disk or network operations. JavaScript can schedule these operations by spinning processes off the event-loop, without blocking the main thread. A common way of doing&lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises"> it is through Promises&lt;/a>.&lt;/p>
&lt;p>Golang HTTP calls are &lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">using JavaScript&amp;rsquo;s &lt;code>fetch&lt;/code>&lt;/a> under the hood, for example. This results in a blocking operation (network call), which needs to be handled properly. Using &lt;code>net/http&lt;/code> functions incorrectly will result in a runtime deadlock error. It is a common mistake, been even pointed out on the &lt;a href="https://pkg.go.dev/syscall/js#FuncOf">&lt;code>syscall/js.FuncOf&lt;/code> documentation&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>Invoking the wrapped Go function from JavaScript will pause the event loop and spawn a new goroutine. Other wrapped functions which are triggered during a call from Go to JavaScript get executed on the same goroutine.&lt;/p>
&lt;p>As a consequence, if one wrapped function blocks, JavaScript&amp;rsquo;s event loop is blocked until that function returns. &lt;strong>Hence, calling any async JavaScript API, which requires the event loop, like fetch (http.Client), will cause an immediate deadlock. Therefore a blocking function should explicitly start a new goroutine.&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>Starting goroutine solves event loop blocking. Image processing would definetely be a blocking operation and definitely be spun up in a goroutine. But, JavaScript doesn&amp;rsquo;t &amp;ldquo;understand&amp;rdquo; them, and the application needs to signal JavaScript runtime to wait for its results. The easiest way is to create a &lt;code>Promise&lt;/code> through &lt;code>syscall/js&lt;/code> and call &lt;code>resolve()&lt;/code> through the goroutine.&lt;/p>
&lt;p>As it is a bit of a long piece of code, abstraction is vital. In ImageWand, this is dealt with through &lt;a href="https://github.com/brunoluiz/imagewand/blob/main/jasm/wasm.go#L37-L57">the jasm.Await function&lt;/a>.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">Await&lt;/span>(&lt;span style="color:#a6e22e">cb&lt;/span> &lt;span style="color:#66d9ef">func&lt;/span>() (&lt;span style="color:#a6e22e">js&lt;/span>.&lt;span style="color:#a6e22e">Value&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)) &lt;span style="color:#a6e22e">js&lt;/span>.&lt;span style="color:#a6e22e">Value&lt;/span> {
&lt;span style="color:#a6e22e">handler&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">js&lt;/span>.&lt;span style="color:#a6e22e">FuncOf&lt;/span>(&lt;span style="color:#66d9ef">func&lt;/span>(&lt;span style="color:#a6e22e">this&lt;/span> &lt;span style="color:#a6e22e">js&lt;/span>.&lt;span style="color:#a6e22e">Value&lt;/span>, &lt;span style="color:#a6e22e">args&lt;/span> []&lt;span style="color:#a6e22e">js&lt;/span>.&lt;span style="color:#a6e22e">Value&lt;/span>) &lt;span style="color:#66d9ef">interface&lt;/span>{} {
&lt;span style="color:#a6e22e">resolve&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">args&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>]
&lt;span style="color:#a6e22e">reject&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">args&lt;/span>[&lt;span style="color:#ae81ff">1&lt;/span>]
&lt;span style="color:#75715e">// This would be the function I want to deal with
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">go&lt;/span> &lt;span style="color:#66d9ef">func&lt;/span>() {
&lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">cb&lt;/span>()
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#a6e22e">reject&lt;/span>.&lt;span style="color:#a6e22e">Invoke&lt;/span>(&lt;span style="color:#a6e22e">Error&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>))
&lt;span style="color:#66d9ef">return&lt;/span>
}
&lt;span style="color:#a6e22e">resolve&lt;/span>.&lt;span style="color:#a6e22e">Invoke&lt;/span>(&lt;span style="color:#a6e22e">res&lt;/span>)
}()
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>
})
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">promiseJS&lt;/span>.&lt;span style="color:#a6e22e">New&lt;/span>(&lt;span style="color:#a6e22e">handler&lt;/span>)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This way, any blocking operation can be created as a promise by wrapping it through this. There is a pull request open at &lt;code>golang/go&lt;/code> &lt;a href="https://github.com/golang/go/pull/52581">that implements a better version of this snippet&lt;/a>, perhaps landing in a future version of Go.&lt;/p>
&lt;h2 id="optimisations">Optimisations&lt;/h2>
&lt;p>Once the proof of concept was up and running, there was a problem: binary size. At this point, building without any optimisation generated a 3.2Mb binary. Not ideal for mobile usage.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">GOOS&lt;span style="color:#f92672">=&lt;/span>js GOARCH&lt;span style="color:#f92672">=&lt;/span>wasm go build -o ./app/wasm/main-go.wasm ./cmd/wasm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The first optimisation one can do is to disable the injection of debugging information on build time through &lt;code>ldflags&lt;/code>. For ImageWand, it reduced the binary to 3.1Mb (2%). Although quite low effort, it doesn&amp;rsquo;t help much.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">GOOS&lt;span style="color:#f92672">=&lt;/span>js GOARCH&lt;span style="color:#f92672">=&lt;/span>wasm go build -o ./app/wasm/main-go-optimal.wasm -ldflags&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;-s -w&amp;#34;&lt;/span> ./cmd/wasm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Tools like &lt;a href="https://rustwasm.github.io/twiggy/">&lt;code>twiggy&lt;/code> can help analyse the binary size&lt;/a> as well. There wasn&amp;rsquo;t much to tweak in this case, but I recommend giving it a try. The one that everyone recommends though, regardless of language, is &lt;code>wasm-opt&lt;/code> from the &lt;a href="http://webassembly.github.io/binaryen/">&lt;code>binaryen&lt;/code> toolchain&lt;/a>.&lt;/p>
&lt;p>It allows many optimisations, but it requires a bit of tweaking per-project basis. After playing around with it, the previous optimised binary with &lt;code>-Oz&lt;/code> produced the best results: a 2.9Mb binary, a 7% reduction compared to the original binary.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">wasm-opt -Oz -o ./app/wasm/main-go-optimal-binaryen.wasm ./app/wasm/main-go-optimal.wasm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>With Golang compiler, this is as far as I could go with optimisations. Even considering Gzip, it didn&amp;rsquo;t look great. It is not rare to find websites reaching 1Mb nowadays but, for such a simple project, 2.9Mb is unacceptable.&lt;/p>
&lt;p>&lt;img loading="lazy" src="./03-benchmark-go.png" alt="Go binary sizes" />
&lt;/p>
&lt;center>
&lt;small>Binary size per optimisation: no excessive gains, but still something&lt;/small>
&lt;/center>
&lt;h2 id="tinygo-a-better-compiler-for-wasm">TinyGo: a better compiler for WASM?&lt;/h2>
&lt;p>I heard about &lt;a href="https://tinygo.org/">TinyGo&lt;/a> sometime ago. With the slogan &amp;ldquo;A Go Compiler For Small Places&amp;rdquo; and a focus on embedded systems, I never got on the hype train. It is a subset of the Golang language, which means &lt;a href="https://tinygo.org/docs/reference/lang-support/">there are some limitations&lt;/a> and not all packages will work on it, even the &lt;a href="https://tinygo.org/docs/reference/lang-support/stdlib/">ones in the standard library&lt;/a>. This means it is not exactly a drop-in for all scenarios.&lt;/p>
&lt;p>But, besides embedded systems, it seems to be a quite popular WASM compiler. The binaries produced, being a subset and focused on &amp;ldquo;small places&amp;rdquo;, are quite small. Taking into consideration the supported packages and limitations, it seemed a good candidate for ImageWand.&lt;/p>
&lt;h3 id="almost-a-drop-in-replacement">Almost a drop-in replacement&lt;/h3>
&lt;p>The first thing I tried was to compile the program using TinyGo, without any changes. It worked incredibly well, and the binary size dropped from ~3.2Mb to ~1.5Mb. Quite an improvement, especially when the WASM target is a web browser.&lt;/p>
&lt;p>This was until I checked the console. Using &lt;code>.String()&lt;/code> to get values from &lt;code>syscall/js.Value&lt;/code> has not been implemented. Seemingly, ImageWand hit a TinyGo limitation and a hack around would be required.&lt;/p>
&lt;br/>
&lt;p>&lt;img loading="lazy" src="./04-tinygo-error.png" alt="TinyGo error" />
&lt;br/>&lt;/p>
&lt;p>&lt;a href="https://github.com/tinygo-org/tinygo/issues/1140">There are some hacks for it&lt;/a>, but they all have some memory leak issues. As the surface between the program functionality and &lt;code>syscall/js&lt;/code> is quite limited, &lt;a href="https://github.com/brunoluiz/imagewand/commit/4860cb4c757c0ad859912047eb145798d47ff434">changing those into &lt;code>int&lt;/code> seemed a better solution (without any caveat)&lt;/a>.&lt;/p>
&lt;p>Besides this, anyone attempting to move from Golang to TinyGo has to replace&lt;a href="https://github.com/tinygo-org/tinygo/blob/release/targets/wasm_exec.js"> &lt;code>wasm_exec.js&lt;/code>&lt;/a>. &lt;a href="https://tinygo.org/docs/guides/webassembly/#how-it-works">According to the documentation&lt;/a>, it is based on the Go&amp;rsquo;s one, but with a couple of changes that make it incompatible. Nothing major and super easy to tackle.&lt;/p>
&lt;p>Once tweaked, ImageWand was successfully compiled using TinyGo, without any error messages in runtime and a binary twice the original size (1.5Mb). Smells like progress!&lt;/p>
&lt;h3 id="tinygo-after-optimisations">TinyGo after optimisations&lt;/h3>
&lt;p>Similar to Golang, the TinyGo compiler &lt;a href="https://tinygo.org/docs/reference/usage/important-options/">allows tweaks&lt;/a> according to project requirements. Considering this will be distributed on the web, optimisations related to size are important. Some might prefer performance tweaks, which are available as well.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">tinygo build -o app/wasm/main-tinygo-optimal.wasm -target wasm -no-debug -gc leaking ./cmd/wasm
wasm-opt -Oz -o ./app/wasm/main-tinygo-optimal-binaryen.wasm ./app/wasm/main-tinygo-optimal.wasm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As in Golang though, &lt;code>wasm-opt&lt;/code> did not result in a massive gain, but it is still something.&lt;/p>
&lt;p>&lt;img loading="lazy" src="./05-benchmark-tinygo.png" alt="TinyGo binary sizes" />
&lt;/p>
&lt;center>
&lt;small>TinyGo binary size per optimisation: drastic improvements when applying optimisations&lt;/small>
&lt;/center>
&lt;br/>
&lt;p>&lt;img loading="lazy" src="./06-benchmark-all.png" alt="TinyGo &amp;#43; Go binary sizes" />
&lt;/p>
&lt;center>
&lt;small>Full binary size comparison from Golang to Tinygo + optimisations&lt;/small>
&lt;/center>
&lt;br/>
&lt;p>If your implementation is compatible with TinyGo and you don&amp;rsquo;t fall into an edge case, go for it! It provides plenty of features, and it seems a good choice in terms of binary size, especially considering web distribution.&lt;/p>
&lt;h3 id="wasi-interesting-but-not-mature-enough-on-tinygo">WASI: interesting but not mature enough on TinyGo&lt;/h3>
&lt;p>At this point, ImageWand was working and it was not a large binary: I could call it a day. But, there was still one thing that I wanted to try out: &lt;a href="https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-overview.md">WASI&lt;/a>.&lt;/p>
&lt;blockquote>
&lt;p>WASI stands for WebAssembly System Interface. It&amp;rsquo;s an API designed by the Wasmtime project that provides access to several operating-system-like features, including files and filesystems, Berkeley sockets, clocks, and random numbers, that we&amp;rsquo;ll be proposing for standardisation.&lt;/p>
&lt;p>&lt;strong>It&amp;rsquo;s designed to be independent of browsers, so it doesn&amp;rsquo;t depend on Web APIs or JS, and isn&amp;rsquo;t limited by the need to be compatible with JS&lt;/strong>. And it has integrated capability-based security, so it extends WebAssembly&amp;rsquo;s characteristic sandboxing to include I/O.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;small>â„¹ï¸ &lt;a href="https://hacks.mozilla.org/2019/03/standardizing-wasi-a-webassembly-system-interface/">There is an interesting article from MDN&lt;/a> about the subject â€“ It is something I definitely want to dive deeper into in the future&lt;/small>&lt;/p>
&lt;p>ImageWand was relying on &lt;code>syscall/js&lt;/code> to interface with user input, which depends on JavaScript APIs, and it wouldn&amp;rsquo;t run in any other runtime besides the browser. Binaries compiled into the WASI standard though can be run anywhere that implements its specification: browser, terminal or within other backends (serverless function with NodeJS running Golang WASI bins). Yes, &amp;ldquo;Build once, run everywhere&amp;rdquo; &lt;del>Java&lt;/del> vibes.&lt;/p>
&lt;p>TinyGo supports WASI. This means &lt;code>syscall/js&lt;/code> is not required if you don&amp;rsquo;t want to manipulate the DOM, which would have made ImageWand code simpler, becoming just an exported Golang functionâ€¦ But, there are a couple of limitations when implementing WASI programs with TinyGo:&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://tinygo.org/docs/concepts/compiler-internals/calling-convention/#:~:text=The%20WebAssembly%20target%20does%20not%20return%20variables%20directly%20that%20cannot%20be%20handled%20by%20JavaScript%20(see%20above%20about%20i64%2C%20also%20struct%2C%20i64%2C%20multiple%20return%20values%2C%20etc).%20Instead%2C%20they%20are%20stored%20into%20a%20pointer%20passed%20as%20the%20first%20parameter%20by%20the%20caller.">Function arguments and outputs can only be numbers or pointers, which are essentially numbers with a memory address&lt;/a>.&lt;/li>
&lt;li>&lt;a href="https://github.com/tinygo-org/tinygo/issues/3010#issuecomment-1191916589">There is no proper support for multi-return, so no easy &lt;code>(someType, error)&lt;/code>&lt;/a> without some hacks.&lt;/li>
&lt;li>Lacking documentation and helper methods to operate on top of shared WASM memory (&lt;a href="https://github.com/tinygo-org/tinygo/issues/3040">I&amp;rsquo;ve opened a ticket around documentation&lt;/a>).&lt;/li>
&lt;/ol>
&lt;p>ImageWand was passing a slice of &lt;code>byte&lt;/code> with the image content, which was the simplest way to get this working (don&amp;rsquo;t io.Reader me: it is not as simple). To pass the image input and receive the output in &lt;code>[]byte&lt;/code>, you need to use JavaScript and WASM shared memory space, pointers and all sort of low-level magic.&lt;/p>
&lt;p>Checking Github, it seems many people came across the issue of passing non-numeric values or returning multiple values, and every developer has a different solution to it &lt;a href="https://github.com/tinygo-org/tinygo/issues/2512#issuecomment-1011399751">[1]&lt;/a> &lt;a href="https://github.com/tinygo-org/tinygo/issues/1824">[2]&lt;/a>.&lt;a href="https://github.com/brunoluiz/imagewand/pull/4"> Eventually, I came up with my way of dealing with this&lt;/a>, but it is quite ugly and probably not efficient at all. Most likely I should have used &lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory">&lt;code>WebAssembly.memory.buffer&lt;/code>&lt;/a>, but I couldn&amp;rsquo;t find an easy way of doing so. Besides, WASI was an extra in this whole experiment and, at this point, I had invested a long time cracking my head to have at least something minimal working.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// JavaScript code
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Uint8Array&lt;/span>(&lt;span style="color:#a6e22e">buf&lt;/span>).&lt;span style="color:#a6e22e">forEach&lt;/span>((&lt;span style="color:#a6e22e">b&lt;/span>) =&amp;gt; &lt;span style="color:#a6e22e">imagewand&lt;/span>.&lt;span style="color:#a6e22e">appendToBuffer&lt;/span>(&lt;span style="color:#a6e22e">b&lt;/span>));
&lt;span style="color:#a6e22e">await&lt;/span> &lt;span style="color:#a6e22e">imagewand&lt;/span>.&lt;span style="color:#a6e22e">convertFromBlob&lt;/span>(&lt;span style="color:#a6e22e">formatToNumber&lt;/span>(&lt;span style="color:#a6e22e">format&lt;/span>));
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">outputSize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">imagewand&lt;/span>.&lt;span style="color:#a6e22e">getOutputSize&lt;/span>();
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">arrayBuffer&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Uint8Array&lt;/span>(&lt;span style="color:#a6e22e">outputSize&lt;/span>);
&lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; &lt;span style="color:#a6e22e">i&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#a6e22e">outputSize&lt;/span>; &lt;span style="color:#a6e22e">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>) {
&lt;span style="color:#a6e22e">arrayBuffer&lt;/span>[&lt;span style="color:#a6e22e">i&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">imagewand&lt;/span>.&lt;span style="color:#a6e22e">getOutputAtPos&lt;/span>(&lt;span style="color:#a6e22e">i&lt;/span>);
}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">// Golang code
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">image&lt;/span> []&lt;span style="color:#66d9ef">byte&lt;/span>
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">input&lt;/span> &lt;span style="color:#a6e22e">image&lt;/span>;
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">output&lt;/span> &lt;span style="color:#a6e22e">image&lt;/span>;
&lt;span style="color:#75715e">//export appendToBuffer
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">appendToBuffer&lt;/span>(&lt;span style="color:#a6e22e">i&lt;/span> &lt;span style="color:#66d9ef">byte&lt;/span>) {
&lt;span style="color:#a6e22e">input&lt;/span> = append(&lt;span style="color:#a6e22e">input&lt;/span>, &lt;span style="color:#a6e22e">i&lt;/span>)
}
&lt;span style="color:#75715e">//export getOutputSize
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">getOutputSize&lt;/span>() &lt;span style="color:#66d9ef">int&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> len(&lt;span style="color:#a6e22e">output&lt;/span>)
}
&lt;span style="color:#75715e">//export getOutputAtPos
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">getOutputAtPos&lt;/span>(&lt;span style="color:#a6e22e">i&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>) &lt;span style="color:#66d9ef">byte&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">output&lt;/span>[&lt;span style="color:#a6e22e">i&lt;/span>]
}
&lt;span style="color:#75715e">// Other stuff
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#75715e">//export convertFromBlob
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">convertFromBlob&lt;/span>(&lt;span style="color:#a6e22e">format&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>) {
&lt;span style="color:#a6e22e">img&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">imagewand&lt;/span>.&lt;span style="color:#a6e22e">New&lt;/span>(&lt;span style="color:#a6e22e">bytes&lt;/span>.&lt;span style="color:#a6e22e">NewBuffer&lt;/span>(&lt;span style="color:#a6e22e">input&lt;/span>))
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
panic(&lt;span style="color:#a6e22e">err&lt;/span>)
}
&lt;span style="color:#a6e22e">f&lt;/span>, &lt;span style="color:#a6e22e">ok&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">fileFormatFromInt&lt;/span>[&lt;span style="color:#a6e22e">format&lt;/span>]
&lt;span style="color:#66d9ef">if&lt;/span> !&lt;span style="color:#a6e22e">ok&lt;/span> {
panic(&lt;span style="color:#e6db74">&amp;#34;format not supported&amp;#34;&lt;/span>)
}
&lt;span style="color:#a6e22e">b&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">bytes&lt;/span>.&lt;span style="color:#a6e22e">NewBuffer&lt;/span>([]&lt;span style="color:#66d9ef">byte&lt;/span>{})
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">img&lt;/span>.&lt;span style="color:#a6e22e">Convert&lt;/span>(&lt;span style="color:#a6e22e">b&lt;/span>, &lt;span style="color:#a6e22e">f&lt;/span>); &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
panic(&lt;span style="color:#a6e22e">err&lt;/span>)
}
&lt;span style="color:#a6e22e">output&lt;/span> = &lt;span style="color:#a6e22e">b&lt;/span>.&lt;span style="color:#a6e22e">Bytes&lt;/span>()
&lt;span style="color:#a6e22e">input&lt;/span> = []&lt;span style="color:#66d9ef">byte&lt;/span>{}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>These limitations and lack of documentation around WASI, workarounds and common examples for TinyGo make it quite hard to abandon &lt;code>syscall/js&lt;/code> for browser apps or use it for non-JS WASM applications. Although I managed to make it work, I wouldn&amp;rsquo;t recommend someone to drop &lt;code>syscall/js&lt;/code> in favour of WASI TinyGo for browser applications at the moment, only if the person wants to deep dive and study its details. If you decide to do so, please help the community by adding examples, tutorials and documentation to the official project page.&lt;/p>
&lt;h2 id="conclusions-on-using-golang-with-wasm">Conclusions on using Golang with WASM&lt;/h2>
&lt;p>Being able to re-use and compile Golang code into WASM is exciting. Besides, for those used to Golang as their daily driver, it might be a natural choice when considering complex applications.&lt;/p>
&lt;p>In general, I always recommend Golang due its tooling. But, for WASM, my experience was quite bumpy:&lt;/p>
&lt;ul>
&lt;li>The final binary size using Golang toolchain (around 3.2Mb) might be OK for the backend but not for frontend apps. This adds up when considering network outbound costs or slow mobile connections.&lt;/li>
&lt;li>TinyGo is an amazing alternative, but you might fall into edge-cases or unsupported features. This is quite an annoyance but, if you manage to get your way around it, it is probably the perfect choice for your Golang WASM project.&lt;/li>
&lt;li>CI pipelines will get more complex as Golang/TinyGo tooling needs to be handled, and &lt;a href="https://github.com/brunoluiz/imagewand/blob/v1.0.0/.github/workflows/deploy.yaml">extra build steps are required&lt;/a>. Not that JavaScript toolchain is not complex by itself already.&lt;/li>
&lt;li>The use of &lt;code>syscall/js&lt;/code> is quite cumbersome and unsafe, but mostly because of the JavaScript nature.&lt;/li>
&lt;li>Dealing with DOM elements is possible, but changing UI elements is quite a painful and complex task. Try to limit its use only as glue.&lt;/li>
&lt;li>Golang WASM is an independent and experimental port. &lt;a href="https://github.com/golang/go/issues/53383">There are discussions on how to deal with such ports&lt;/a>, but it is something to bear in mind. Besides, as it is still not a stable API, it might change at any point (although it never changed since its release).&lt;/li>
&lt;li>WASI support is Golang does not exist at the moment, and TinyGo is not the most ergonomic in terms of WASI development, with a lack of documentation and examples. This can be mostly due to the WASI specification, as it is still in progress, but things like &lt;code>wasm-bindgen&lt;/code> for Rust prove that it could be somehow possible.&lt;/li>
&lt;/ul>
&lt;p>Would I choose Golang for a WASM project? If I had to develop something quickly or the people involved are used to Golang, definitely yes (TinyGo, to be fair). But I feel it is not the best choice in terms of features, documentation, toolchain and support. C/C++ and Rust seem to lead the way.&lt;/p>
&lt;p>I never programmed with Rust before, but considering its support to WASM and some other interesting use cases I have in mind, it is perhaps a sign that I should finally try to learn it.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://imagewand.concordalabs.com">ðŸ”— ImageWand project page&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/brunoluiz/imagewand">ðŸ’¾ ImageWand source code&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://twitter.com/brunoluiz">ðŸ’¬ Reach me on Twitter @ brunoluiz&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="references">References&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://withblue.ink/2020/10/03/go-webassembly-http-requests-and-promises.html">Go, WebAssembly, HTTP requests and Promises&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developer.mozilla.org/en-US/docs/Glossary/Transferable_objects">MDN: Transferable objects&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://qvault.io/golang/running-go-in-the-browser-wasm-web-workers/">Running Go in the Browser with WASM and Web Workers&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.sitepen.com/blog/using-webassembly-with-web-workers">Using WebAssembly with Web Workers&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.fermyon.com/blog/optimizing-tinygo-wasm">Shrink Your TinyGo WebAssembly Modules by 60%&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://elewis.dev/are-we-wasm-yet-part-1">Are We Wasm Yet ? - Part 1&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://elewis.dev/are-we-wasm-yet-part-2#heading-server-implementation">Are We Wasm Yet ? - Part 2&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://hacks.mozilla.org/2019/03/standardizing-wasi-a-webassembly-system-interface/">Standardizing WASI: A system interface to run WebAssembly outside the web&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wasi.dev/">WASI&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wasmbyexample.dev/examples/webassembly-linear-memory/webassembly-linear-memory.go.en-us.html#">WebAssembly Linear Memory example&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>GIFs (sane) playback control using WASM and FFmpeg</title><link>https://brunoluiz.net/blog/2022/jan/gif-sane-playback-control-ffmpegwasm/</link><pubDate>2022-01-20</pubDate><guid>https://brunoluiz.net/blog/2022/jan/gif-sane-playback-control-ffmpegwasm/</guid><description>&lt;p>&lt;img loading="lazy" src="./cover.jpg" alt="Photo by Stephen Monterroso on Unsplash" />
&lt;/p>
&lt;!-- https://unsplash.com/photos/cwcPV_VKfy4 -->
&lt;p>Animated images in GIF format are around for a long time. They were first released in 1987 by CompuServe. Yep, your maths are correct: they came even before browsers. It was not until Netscape 2.0 that the GIF format was incorporated and conquered the world (&lt;a href="https://www.vox.com/culture/2017/6/15/15802136/gif-turns-30-evolution-internet-history">really&lt;/a>).&lt;/p>
&lt;p>They are everywhere: from memes to artsy GIFs, they come in all shapes and formats. The software engineering world adopted them for a particular use case: recording tutorials and demos.&lt;/p>
&lt;p>Markdown probably is to blame here. Embedding a GIF into your Github page, static blog or NPM package, which tend to use Markdown, is the easiest way to embed a &amp;ldquo;video-like&amp;rdquo; component: &lt;code>![](./img.gif)&lt;/code> and all good.&lt;/p>
&lt;p>GIFs are ominous nowadays, being more popular than even newer and more efficient formats, such as &lt;a href="https://developer.mozilla.org/en-US/docs/Web/Media/Formats/Image_types#webp_image">WEBP&lt;/a> or &lt;a href="https://developer.mozilla.org/en-US/docs/Web/Media/Formats/Image_types#apng_animated_portable_network_graphics">APNG&lt;/a>. But, depending on their length and what has been recorded, you might want to pause, go back, jump sections etc. Video playback features basically&amp;hellip; which GIFs don&amp;rsquo;t have.&lt;/p>
&lt;p>Not having this feature always annoyed me a bit. I always &lt;em>secretly&lt;/em> hoped that one day browsers would support this. This day never arrived, and I decided to take matters into my own hands.&lt;/p>
&lt;h2 id="browser-extensions-a-ticket-to-heaven">Browser extensions: a ticket to heaven?&lt;/h2>
&lt;p>Some time ago, I was a bit annoyed with Grammarly. As a non-native English speaker, it helps me a lot when writing technical documents or blog posts. But these documents had to be exported to Markdown.&lt;/p>
&lt;p>At some point, I got annoyed by the lack of this feature, and I decided to create a browser extension to solve that: &lt;a href="https://brunoluiz.net/grammarly-markdown-extension/">Grammarly to Markdown&lt;/a> (&lt;a href="https://github.com/brunoluiz/grammarly-markdown-extension">GitHub&lt;/a>). This was 2019, and I still use it nowadays.&lt;/p>
&lt;p>Then, last year, James Long published &lt;a href="https://jlongster.com/future-sql-web">&lt;em>A future for SQL on the web&lt;/em>&lt;/a>, where he describes how to use SQLite in the browser. &amp;ldquo;SQLite, in the browser!? How!?&amp;rdquo; you may ask. Well, dear friend, there is this magical thing called &lt;a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Concepts">&lt;em>WebAssembly&lt;/em>&lt;/a>. In this case, it allows JavaScript to interoperate with libraries and programs written in other languages, such as SQLite.&lt;/p>
&lt;p>I already knew about the existence of WASM, but this post was eye-opening. I realised it opens many interesting possibilities and, during my search for other projects, I came across &lt;a href="https://github.com/ffmpegwasm/ffmpeg.wasm">FFmpeg.wasm&lt;/a>.&lt;/p>
&lt;p>At some point last year, my annoyance with GIFs came about again. I tried some extensions, but the UI and UX were never that friendly. I was expecting something like HTML playback control.&lt;/p>
&lt;p>With my &amp;ldquo;&lt;em>fresh&amp;rdquo;&lt;/em> knowledge about WASM, I thought: wait a second, what if I created a browser extension that converted GIFs into videos using FFMPEG!? Guess what: I did it again.&lt;/p>
&lt;h2 id="ffmpegwasm--browser-extension-gifsane">FFmpeg.wasm + Browser Extension: GIFSane&lt;/h2>
&lt;p>&lt;img loading="lazy" src="./demo.webp" alt="" />
&lt;/p>
&lt;p>&lt;em>Fun fact: the demo above is in WebP, so GIF wouldn&amp;rsquo;t be able to convert ðŸ¤·&lt;/em>&lt;/p>
&lt;p>After a couple of weeks of hacking things, I managed to put together &lt;a href="https://github.com/brunoluiz/gifsane-extension">GIFSane&lt;/a>. It allows users to either convert and replace the image component or download the converted result straight (QuickTime can&amp;rsquo;t open it though). For now, I can&amp;rsquo;t publish in Chrome Web Store (more details on sections ahead), but you can still load it manually (instructions on the repository).&lt;/p>
&lt;p>It is not as fast as a &amp;ldquo;bare-metal&amp;rdquo; FFmpeg (no hardware acceleration) but is way more convenient. Besides, it was a great opportunity to learn more about WebAssembly.&lt;/p>
&lt;p>Creating extensions, however, can always be tricky. There are lots of caveats, tricks and not properly documented APIs. It is certainly not an easy and quick project to hack around. Besides, FFmpeg.wasm has its own set of limitations (or rather WASM itself).&lt;/p>
&lt;h2 id="here-be-dragons-extensions-using-wasm-and-ffmpeg">Here be dragons: extensions using WASM and FFmpeg&lt;/h2>
&lt;p>Differently from frontend and backend, where there are lots of materials, tutorials and frameworks, extensions are quite the opposite.&lt;/p>
&lt;p>I will not go through the whole implementation. Instead, I will go through my main learnings in this project, mostly around WASM and FFmpeg. The extension itself is simply architected, and you can &lt;a href="https://github.com/brunoluiz/gifsane-extension">explore it at GitHub&lt;/a>.&lt;/p>
&lt;h3 id="manifest-v3-vs-v2-january-2022-limitations-everywhere">Manifest V3 vs V2 (January 2022): limitations everywhere&lt;/h3>
&lt;p>Manifest V3 will be a requirement from January 2023 onwards. If you want to publish an extension to Chrome Web Store, be aware that only Manifest V3 is accepted currently.&lt;/p>
&lt;p>Chrome-based engines are the only ones supporting it, while Firefox is still on Manifest V2. This means that you might have to support two versions of the same extension. &lt;a href="https://blog.mozilla.org/addons/2021/05/27/manifest-v3-update/">Mozilla is supposed to release its implementation soon&lt;/a>, but it seems there will be divergences.&lt;/p>
&lt;p>For GIFSane though, I couldn&amp;rsquo;t even use Manifest V3. As of January 2022, &lt;a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1173354">it still does not support WASM&lt;/a>. Developers who want to build on top of WASM still need to wait. Hence why it is not available on Chrome Web Store.&lt;/p>
&lt;p>Besides, background scripts &lt;a href="https://developer.chrome.com/docs/extensions/mv3/intro/mv3-overview/#service-workers">need to be migrated to service workers.&lt;/a> Depending on the implementation, this might be tricky. FFmpeg.wasm, for one, uses &lt;code>[URL.createObjectURL()][14]&lt;/code> and &lt;code>document.\*&lt;/code> in its browser version, both not available in workers.&lt;/p>
&lt;h3 id="sharedarraybuffer--spectre">SharedArrayBuffer &amp;amp; SPECTRE&lt;/h3>
&lt;p>To make use of multi-threading, applications compiled with WASM require &lt;code>SharedArrayBuffer&lt;/code>. But, since &lt;a href="https://meltdownattack.com/">SPECTRE&lt;/a> (the security vulnerability, not the Bond movie), this has been a minefield for browsers.&lt;/p>
&lt;p>All major browsers &lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer#security_requirements">disabled it at the start of 2018&lt;/a>, only re-enabling it in 2020. If you want a website to use this, you need to set &lt;code>Cross-Origin-Opener-Policy&lt;/code> and &lt;code>Cross-Origin-Embedder-Policy&lt;/code> headers. &lt;a href="https://developer.chrome.com/docs/extensions/mv2/manifest/cross_origin_embedder_policy/">Extensions have to set those as well&lt;/a> to be able to use WASM.&lt;/p>
&lt;p>The caveat is that, on Firefox, &lt;a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1674383">extensions can&amp;rsquo;t use &lt;code>SharedArrayBuffer&lt;/code>&lt;/a>. Only a few &lt;a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1674383#c33">privileged extensions can&lt;/a>, which forbids the usage of multi-threaded WASM extensions on Firefox.&lt;/p>
&lt;h3 id="single-threaded-ffmpegwasm-is-possible-">Single-threaded FFmpeg.wasm is possible ðŸš€&lt;/h3>
&lt;p>&lt;img loading="lazy" src="./fixing.jpg" alt="Photo by Michael Dziedzic on Unsplash" />
&lt;/p>
&lt;!-- Photo by &lt;a href="https://unsplash.com/@lazycreekimages?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Michael Dziedzic&lt;/a> on &lt;a href="https://unsplash.com/s/photos/fix?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash&lt;/a> -->
&lt;p>On the bright side: WASM applications can be compiled to single-threaded, and FFMPEG.wasm is no different. It removes the need for &lt;code>SharedArrayBuffer&lt;/code> with the only caveat being it will be certainly slower.&lt;/p>
&lt;p>As of January 2022, there is no &amp;ldquo;pre-packaged&amp;rdquo; FFMPEG.wasm available with single-threaded support. But &lt;a href="https://github.com/jeromewu">@jeromewu&lt;/a> already pushed the required changes to compile it. This means you will need to get your hands a little bit dirty.&lt;/p>
&lt;p>&lt;strong>Build &lt;code>ffmpeg.wasm-core&lt;/code>&lt;/strong>&lt;/p>
&lt;p>You can build manually by heading to &lt;a href="https://github.com/ffmpegwasm/ffmpeg.wasm-core">https://github.com/ffmpegwasm/ffmpeg.wasm-core&lt;/a> and following the instructions. Or, you can use GitHub Actions in your favour:&lt;/p>
&lt;ul>
&lt;li>Fork the project: &lt;a href="https://github.com/ffmpegwasm/ffmpeg.wasm-core">https://github.com/ffmpegwasm/ffmpeg.wasm-core&lt;/a>&lt;/li>
&lt;li>Enable the GitHub Actions (just go to the Actions tab)&lt;/li>
&lt;li>Push a dummy commit&lt;/li>
&lt;li>There should be two workflows running in your GitHub Actions: select &lt;code>Build FFmpeg.wasm (Single Thread)&lt;/code>&lt;/li>
&lt;li>It will take ages to compile: go make a coffee â˜•ï¸&lt;/li>
&lt;li>Once finished, download the artefacts (bottom of the page)&lt;/li>
&lt;/ul>
&lt;p>Now you should have a working single-thread version of it.&lt;/p>
&lt;p>&lt;strong>Build &lt;code>ffmpeg.wasm&lt;/code>&lt;/strong>&lt;/p>
&lt;p>If you change the &lt;code>corePath&lt;/code> param of &lt;code>createFFmpeg&lt;/code> to use the single-threaded version, you will realise that it still does not work. Worse: now it errors with:&lt;/p>
&lt;pre>&lt;code>[fferr] Assertion failed: Cannot call unknown function proxy_main, make sure it is exported
Uncaught (in promise) RuntimeError: abort(Assertion failed: Cannot call unknown function proxy_main, make sure it is exported). Build with -s ASSERTIONS=1 for more info.
&lt;/code>&lt;/pre>&lt;p>When you build without multi-threading, &lt;code>proxy_main&lt;/code> is not published anymore. From what I understood, this is because &lt;code>proxy_main&lt;/code> is used as a &amp;ldquo;proxy&amp;rdquo; entry point by ECMScripten when dealing with multi-threading + workers just so it doesn&amp;rsquo;t block the main thread (&lt;a href="https://emscripten.org/docs/porting/pthreads.html">more details here&lt;/a>). With the single-threaded binary, this proxy will not be available. Instead, you should use &lt;code>main&lt;/code>.&lt;/p>
&lt;p>There &lt;a href="https://github.com/ffmpegwasm/ffmpeg.wasm/pull/235">is a fix for this already&lt;/a>, but it still hasn&amp;rsquo;t been merged. Guess what: time to get your hands dirty again:&lt;/p>
&lt;ul>
&lt;li>Fork the project: &lt;a href="https://github.com/ffmpegwasm/ffmpeg.wasm-core">https://github.com/ffmpegwasm/ffmpeg.wasm&lt;/a>&lt;/li>
&lt;li>Apply the patches from &lt;a href="https://github.com/ffmpegwasm/ffmpeg.wasm/pull/235/files">https://github.com/ffmpegwasm/ffmpeg.wasm/pull/235/files&lt;/a>&lt;/li>
&lt;li>Build the package with &lt;code>npm ci &amp;amp;&amp;amp; npm build&lt;/code> (no coffee this time, it is quick to compile)&lt;/li>
&lt;/ul>
&lt;p>You can now use the single-threaded FFmpeg.wasm in your project:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">ffmpeg&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">createFFmpeg&lt;/span>({
&lt;span style="color:#a6e22e">corePath&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;./&amp;lt;path-to-ffmpeg-core-dist&amp;gt;/ffmpeg-core.js&amp;#39;&lt;/span>,
&lt;span style="color:#a6e22e">mainName&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;main&amp;#39;&lt;/span>
});
&lt;/code>&lt;/pre>&lt;/div>&lt;p>If you want your extension to support both, you will have to keep both WASM files and change things in build time (&lt;a href="https://github.com/brunoluiz/gifsane-extension/blob/main/package.json#L8-L9">I used symbolic links&lt;/a>). You need to detect the browser and change the &lt;code>mainName&lt;/code> entry point during run-time (&lt;a href="https://github.com/brunoluiz/gifsane-extension/blob/main/src/handlers/ffmpeg-handler.js#L1-L9">a bit tricky in extensions&lt;/a>).&lt;/p>
&lt;h3 id="no-mp4h264-support-on-firefox">No MP4/H.264 support on Firefox&lt;/h3>
&lt;p>&lt;a href="https://support.mozilla.org/en-US/kb/html5-audio-and-video-firefox#w_patented-media">Firefox does not include the required codecs to play MP4 (H.264)&lt;/a>. I always thought it got open-sourced at some point, but I was clearly too naive. Instead, they recommend WebM (VP9).&lt;/p>
&lt;p>FFmpeg.wasm supports both. But, there is a catch: GIF to WebM encoding is slower than MP4&amp;rsquo;s. Sadly, Firefox users have a double performance penalty with FFmpeg.wasm. Either way, slow is better than nothing, and GIFSane supports WebM encoding as well.&lt;/p>
&lt;h3 id="dealing-with-csp-headers-to-inject-blobs-ffmpeg-output-in-any-page">Dealing with CSP headers to inject Blobs (FFmpeg output) in any page&lt;/h3>
&lt;p>Initially, GIFSane used a content script to run FFmpeg. But:&lt;/p>
&lt;ol>
&lt;li>It was inefficient, as all pages loaded GIFSane resources (mainly ffmpeg.wasm)&lt;/li>
&lt;li>Some websites &lt;code>[Content Security Policy][30]&lt;/code> block any content injection to it. GitHub is quite aggressive in these policies, for example.&lt;/li>
&lt;/ol>
&lt;p>Once FFmpeg.wasm was moved to a background script, I managed to run FFmpeg and convert GIFs. It still required a hack to pass the final MP4 from the background to the content script. This is because extensions don&amp;rsquo;t emit JS objects, but stringified versions of them instead. I obviously found my way ðŸ¤· (&lt;a href="https://github.com/brunoluiz/gifsane-extension/blob/main/src/handlers/ffmpeg-handler.js#L71-L78">exhibit A&lt;/a>, &lt;a href="https://github.com/brunoluiz/gifsane-extension/blob/main/src/content.js#L49-L50">exhibit B&lt;/a>).&lt;/p>
&lt;p>But, even with this workaround, I couldn&amp;rsquo;t inject the blob into the page. Some websites declare &lt;code>media-src&lt;/code> in their CSP headers, which blocks media injection (like blobs). Another ~duct tape~ hack had to be applied, with a little help from &lt;code>chrome.webRequest.onHeadersReceived&lt;/code>.&lt;/p>
&lt;p>With this API, the &lt;code>onHeadersReceived&lt;/code> is called once the page HTTP Headers are received. GIFSane reads them and changes them just a tiny bit: &lt;a href="http://chrome.webRequest.onHeadersReceived">it adds &lt;code>blob:&lt;/code> to the CSP &lt;code>media-src&lt;/code>&lt;/a>. After that, the GIFSane content script can replace the GIF with the FFmpeg output. I am not sure if this is a reason for security concerns, but it was my only way around it (please, &lt;a href="https://twitter.com/brunoluiz">ping me on Twitter&lt;/a> if it is).&lt;/p>
&lt;h2 id="final-words">Final words&lt;/h2>
&lt;p>&lt;img loading="lazy" src="./conclusion.jpg" alt="Photo by Javier Allegue Barros on Unsplash" />
&lt;/p>
&lt;p>Creating GIFSane was an interesting challenge. I now want to go deeper into WASM and perhaps convert a project myself (I am open to ideas).&lt;/p>
&lt;p>Because it doesn&amp;rsquo;t have hardware acceleration, it is a bit slow at times. As long as developers don&amp;rsquo;t push 5 minutes GIFs, FFmpeg.wasm should be enough. If not, I might create an external agent which calls a bare-metal FFmpeg.&lt;/p>
&lt;p>Closer to the end of the year, I will revisit this post and GIFSane due to Manifest V3 migrations. Expect a Part II soon ðŸ‘€&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/brunoluiz/gifsane">ðŸ”— GIFSane project page&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://twitter.com/brunoluiz">ðŸ’¬ Reach me on Twitter @ brunoluiz&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>The forgotten art of HTML redirects, without either HTTP 301 or JavaScript</title><link>https://brunoluiz.net/blog/2021/jun/redirect-users-client-side-only/</link><pubDate>2021-06-17</pubDate><guid>https://brunoluiz.net/blog/2021/jun/redirect-users-client-side-only/</guid><description>&lt;p>&lt;img loading="lazy" src="cover.jpg" alt="Photo by Javier Allegue Barros on Unsplash" />
&lt;/p>
&lt;p>One of the first things API developers learn is HTTP codes. Usually, people already saw some 404 around, but soon they learn about the uses of 2xx, 4xx and 5xx codes. Probably you, insidious reader, realised I jumped the 3xx series.&lt;/p>
&lt;p>Most first time developers never hear about 3xx, but probably because most haven&amp;rsquo;t gone through some scenario requiring it. There are many codes in this series, but the code of interest here is HTTP 301. If a developer wants to redirect users, returning 301 will indicate to the client that the resource was moved permanently to a new address (specified in the response).&lt;/p>
&lt;p>HTTP 301 can be useful in many cases:&lt;/p>
&lt;ul>
&lt;li>Redirect URLs if there was a major URL change in a website (xyz.com/blog/2020/01/some-title to xyz.com/some-title).&lt;/li>
&lt;li>Create redirect flows for auth (OAuth; redirect on user log-out).&lt;/li>
&lt;li>Shorten URLs (redirect xyz.com/foo to foo.com).&lt;/li>
&lt;/ul>
&lt;p>These can only be returned by HTTP servers. But, there are times you might not want to maintain an HTTP server. You might have a static generated website, where you want to redirect old URLs to new URLs (due to SEO), or just have shortened URLs together with your static website.&lt;/p>
&lt;p>Instead of setting up and maintaining an HTTP server, or relying on some third party to set up the redirects for your static site (example: Netlify or Vercel redirect configs), you can use static (HTML) files instead.&lt;/p>
&lt;p>One could use JavaScript to set &lt;code>window.location=https://foo.bar&lt;/code>, but this might not work as some people are browsing with JavaScript disabled nowadays. The real answer lies on &lt;code>&amp;lt;meta http-equiv=&amp;quot;refresh&amp;quot; /&amp;gt;&lt;/code>.&lt;/p>
&lt;p>It works as an HTTP redirect code, but it is done completely on the client-side. This feature was introduced back &lt;a href="https://www.w3.org/TR/WCAG20-TECHS/H76.html">in Netscape 1.1, back in 1995&lt;/a> and &lt;a href="https://ogp.me/">there is a bit more explanation on the W3C website&lt;/a>. It is still recommended to use HTTP redirects instead of this, but static websites might not have this choice sometimes (content hosted on Github Pages, for example).&lt;/p>
&lt;p>To try it out, create an HTML file with the following code and then open it in the browser. The browser should load the file and redirect straight to the target URL.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&lt;span style="color:#75715e">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&amp;lt;&lt;span style="color:#f92672">html&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">head&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">title&lt;/span>&amp;gt;Bruno L. Silva - Twitter&amp;lt;/&lt;span style="color:#f92672">title&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">http-equiv&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;refresh&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;0; url=https://twitter.com/brunoluiz&amp;#34;&lt;/span> /&amp;gt;
&amp;lt;/&lt;span style="color:#f92672">head&lt;/span>&amp;gt;
&amp;lt;/&lt;span style="color:#f92672">html&lt;/span>&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As promised, this is plain HTML. But, creating files like this can get a bit annoying. Besides, if you host this file in Github Pages and share the link around, the metadata of the target URL will not be present (example: &lt;code>&amp;lt;title&amp;gt;&lt;/code>, &lt;a href="https://ogp.me/">OpenGraph&lt;/a> and &lt;a href="https://developer.twitter.com/en/docs/twitter-for-websites/cards/guides/getting-started">Twitter Card&lt;/a> meta tags). This means Facebook, Twitter, messengers and others will not render a card with the target details, as in the images below.&lt;/p>
&lt;p>&lt;img loading="lazy" src="./meta-example.png" alt="" />
&lt;/p>
&lt;p>To avoid the manual work of copying metadata around and setting these files manually, I&amp;rsquo;ve created a tool called &lt;a href="https://github.com/brunoluiz/urlzap">URLZap&lt;/a>. Based on a YAML config, it creates HTML files with all the required metadata and the redirect HTML meta tag. There are details on how to use it, both through CLI or Github Actions, &lt;a href="https://github.com/brunoluiz/urlzap">on the project&amp;rsquo;s page&lt;/a>.&lt;/p>
&lt;p>The YAML configuration and output files will looks like the snippets below.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#75715e"># Example configuration file to be used with: urlzap generate --config ./config.yaml&lt;/span>
&lt;span style="color:#f92672">path&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;./output&amp;#39;&lt;/span>
&lt;span style="color:#f92672">urls&lt;/span>:
&lt;span style="color:#f92672">github&lt;/span>: &lt;span style="color:#ae81ff">https://github.com&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&lt;span style="color:#75715e">&amp;lt;!-- Example output at ./output/github/index.html --&amp;gt;&lt;/span>
&lt;span style="color:#75715e">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&amp;lt;&lt;span style="color:#f92672">html&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">head&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">title&lt;/span>&amp;gt;GitHub: Where the world builds software Â· GitHub&amp;lt;/&lt;span style="color:#f92672">title&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">link&lt;/span> &lt;span style="color:#a6e22e">rel&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;canonical&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">href&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;https://github.com&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;robots&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;noindex&amp;#34;&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">charset&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;utf-8&amp;#34;&lt;/span> /&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">http-equiv&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;refresh&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;0; url=https://github.com&amp;#34;&lt;/span> /&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;description&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;GitHub is where over 65 million developers shape the future of software, together. Contribute to the open source community, manage your Git repositories, review code like a pro, track bugs and features, power your CI/CD and DevOps workflows, and secure code before you commit it.&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;fb:app_id&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1401488693436528&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;twitter:image:src&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;https://github.githubassets.com/images/modules/site/social-cards/github-social.png&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;twitter:site&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;@github&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;twitter:card&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;summary_large_image&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;twitter:title&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;GitHub: Where the world builds software&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;twitter:description&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;GitHub is where over 65 million developers shape the future of software, together. Contribute to the open source community, manage your Git repositories, review code like a pro, track bugs and feat...&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:image&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;https://github.githubassets.com/images/modules/site/social-cards/github-social.png&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:image:alt&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;GitHub is where over 65 million developers shape the future of software, together. Contribute to the open source community, manage your Git repositories, review code like a pro, track bugs and feat...&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:site_name&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;GitHub&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:type&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;object&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:title&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;GitHub: Where the world builds software&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:url&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;https://github.com/&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:description&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;GitHub is where over 65 million developers shape the future of software, together. Contribute to the open source community, manage your Git repositories, review code like a pro, track bugs and feat...&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:image:type&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;image/png&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:image:width&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1200&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">property&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;og:image:height&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;620&amp;#34;&lt;/span>/&amp;gt;
&amp;lt;/&lt;span style="color:#f92672">head&lt;/span>&amp;gt;
&amp;lt;/&lt;span style="color:#f92672">html&lt;/span>&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As mentioned on the W3C page, it is recommended that developers use HTTP 301 instead of this strategy. But there are some valid use cases in which you might end up using this strategy. With or without URLZap, anyone hosting websites statically should be able to have redirects without having to maintain or pay a web server. It can be hosted virtually anywhere, and all browsers support it.&lt;/p>
&lt;p>And well, it is always interesting to find different ways to do things we take for granted ðŸ™ƒ&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/brunoluiz/urlzap">ðŸ”— URLZap project page&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://twitter.com/brunoluiz">ðŸ’¬ Reach me on Twitter @ brunoluiz&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Getting good code reviews from peers</title><link>https://brunoluiz.net/blog/2020/sep/getting-good-code-reviews/</link><pubDate>2020-09-28</pubDate><guid>https://brunoluiz.net/blog/2020/sep/getting-good-code-reviews/</guid><description>&lt;p>&lt;img loading="lazy" src="cover.jpg" alt="Photo by Glenn Carstens-Peters on Unsplash" />
&lt;/p>
&lt;p>Every software developer, soon after pushing code to the repository, has this urge to ping the team to ask for code review. But, I dare to say: don&amp;rsquo;t do it! Most likely some adjusments and checks can still be done, especially if this is your first push for this feature.&lt;/p>
&lt;p>The following guidelines might help you to get better and faster code reviews.&lt;/p>
&lt;blockquote>
&lt;p>&lt;em>Disclaimer: I am using some Github terminology (Pull Request, Draft PR), but it should apply to other repository hosting services.&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;h1 id="be-your-first-reviewer-and-tester">Be your first reviewer and tester&lt;/h1>
&lt;p>As mentioned, many might be eager to ask for reviews straight away. But what if your first reviewer was you? Check the code for usual issues, such as unnecessary comments, intricated logic or even some test script you wrote and committed by accident (who never?).&lt;/p>
&lt;p>Check your tests and run the test suite, if the team has one (if it doesn&amp;rsquo;t, perhaps it is time to add one). Or even try it with a few manual tests. It will guarantee the feature doesn&amp;rsquo;t contain a breaking change or any other funny behaviour.&lt;/p>
&lt;p>It will clear the way for teammates to focus on what matters for the feature.&lt;/p>
&lt;h1 id="create-small-pull-requests">Create small Pull Requests&lt;/h1>
&lt;p>Sometimes we might end-up including too much code in one Pull Request. Splitting it into small ones will make reviewers lives easier.&lt;/p>
&lt;p>It will narrow down the scope, and it might raise some interesting discussions before going ahead with more implementations. Besides, smaller amounts of code are faster to review and understand ðŸ™‚.&lt;/p>
&lt;p>Examples of splittable code:&lt;/p>
&lt;ul>
&lt;li>Updates on schemas or any type model, as the team might want to discuss it before going ahead&lt;/li>
&lt;li>Tooling updates (scripts or shared libs/SDK), as it might be of interest of other people outside the team&lt;/li>
&lt;li>If there is a story ticket with sub-tasks, use the sub-tasks as a guide for opening pull requests&lt;/li>
&lt;/ul>
&lt;h1 id="use-comments-to-open-discussions">Use comments to open discussions&lt;/h1>
&lt;p>Most repository hosting services have tools to allow developers to comment in pull requests. As you review your code, these are some points you might want to discuss:&lt;/p>
&lt;ol>
&lt;li>Discuss if an implementation is the best approach to the problem or if it is consistent with similar features&lt;/li>
&lt;li>Discuss if &lt;a href="https://en.wikipedia.org/wiki/Programming_idiom">the code is idiomatic&lt;/a> for the language or framework&lt;/li>
&lt;li>Point-out to possible breaking changes or disruptive codes (example: possible data loss)&lt;/li>
&lt;li>Point out relevant bits of the code, where much of the logic happens&lt;/li>
&lt;/ol>
&lt;p>&lt;img loading="lazy" src="idiomatic-screenshot.png" alt="Is this idiomatic code?" />
&lt;/p>
&lt;h1 id="drafts-might-help-in-big-teams">Drafts might help in big teams&lt;/h1>
&lt;p>Sometimes, people get stuck in some part, and that is where asking your mates might be a good call. Push, open a pull request, label as &amp;ldquo;WIP&amp;rdquo; and send it to some people&amp;hellip; right?&lt;/p>
&lt;p>The problem with this approach is that, in big teams, many code owners might be associated with this project. Usually, members are automatically notified on pull requests, and some people might not like the noise (e-mails, Github bots and so on).&lt;/p>
&lt;p>Most services have the concept of &amp;ldquo;draft pull request&amp;rdquo; (&lt;a href="https://docs.github.com/en/free-pro-team@latest/github/collaborating-with-issues-and-pull-requests/creating-a-pull-request">Github&lt;/a>, &lt;a href="https://docs.gitlab.com/ee/user/project/merge_requests/work_in_progress_merge_requests.html">Gitlab&lt;/a>), which do not automatically request reviews from the code owners. For work in progress pull requests, this is quite helpful and highly recommended.&lt;/p>
&lt;p>&lt;img loading="lazy" src="draft-screenshot.png" alt="Is this idiomatic code?" />
&lt;/p>
&lt;p>Once it is ready for review, you can convert from draft to pull request and profit ðŸ˜‰.&lt;/p>
&lt;h1 id="descriptions-always-help">Descriptions always help&lt;/h1>
&lt;p>The team might exactly know what to expect for this feature, and there might be even a ticket with more details. But humans tend to forget details, and a clear description of what is supposed to do might be helpful.&lt;/p>
&lt;p>If there is a ticket, replicating some bits in the description might be helpful as well. Someone might need to come back to it after months, or even other teams might want to peek into it. Most likely, just a few will remember details and this description could be of huge help in these moments.&lt;/p>
&lt;h1 id="continuous-integration-automation-automation-automation">Continuous integration: automation, automation, automation&amp;hellip;&lt;/h1>
&lt;p>&lt;img loading="lazy" src="circleci-screenshot.png" alt="Release automation" />
&lt;/p>
&lt;p>Humans make mistakes. Who never pushed code with inconsistent formatting, logging calls, skipping some tests and so on? Reviewing these mistakes is a bit annoying (although doable), mostly because usually they could be 100% avoided.&lt;/p>
&lt;p>With tools such as &lt;a href="https://circleci.com/">CircleCI&lt;/a> or &lt;a href="https://github.com/features/actions">Github Actions&lt;/a>, a team can automate these tasks and mark the feature as &amp;ldquo;mergeable&amp;rdquo; only if all of those passed. It is what is called &lt;a href="https://martinfowler.com/articles/continuousIntegration.html">continuous integration&lt;/a>.&lt;/p>
&lt;p>Things that could be easily automated:&lt;/p>
&lt;ul>
&lt;li>Tests: if the project has them (it should), the commands to run them should be easy to include in the automation&lt;/li>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Lint_(software)">Linting&lt;/a>: checks if the code follows code guidelines decided by the team, enabling to catch bugs and other programming errors. Most languages have linting tools, with many available configurations (examples: ESLint, golangci-lint)&lt;/li>
&lt;li>Building: from binaries to docker images, why not add this process to your automation pipeline?&lt;/li>
&lt;li>Deploying: depending on the team workflow, it might be even possible to deploy these straight to staging or production (continuous delivery)&lt;/li>
&lt;li>Publishing: if the project is some tool, it can publish in the specific platform (screenshot example)&lt;/li>
&lt;/ul>
&lt;p>These are just examples. Your team might have different requirements and tasks, which could be configured into your continuous integration.&lt;/p>
&lt;h1 id="dont-be-the-rockstar-coder">Don&amp;rsquo;t be &amp;ldquo;the rockstar&amp;rdquo; coder&lt;/h1>
&lt;p>Besides all the above, be honest and genuine when asking questions, discussing topics or bringing new things (tooling, models, ways of code). Consider that people will spend some time to check your progress, and give feedback and recommendations. They are doing this genuinely, and so should you.&lt;/p>
&lt;p>Don&amp;rsquo;t be &amp;ldquo;that guy&amp;rdquo;, the one who knows everything and whos opinion is the only that matters.&lt;/p>
&lt;h1 id="conclusion">Conclusion&lt;/h1>
&lt;p>I hope these steps are small enough to be easily integrated into your workflow. At some point, you might be able to convince other team members to use some of these as well. Integrate it in steps, to make it smoother to everyone ðŸ˜‰.&lt;/p></description></item><item><title>GRPC: A powerful way to improve your Golang APIs</title><link>https://brunoluiz.net/blog/2019/nov/grpc-a-powerful-way-to-improve-golang-apis/</link><pubDate>2019-12-05</pubDate><guid>https://brunoluiz.net/blog/2019/nov/grpc-a-powerful-way-to-improve-golang-apis/</guid><description>&lt;p>&lt;img loading="lazy" src="cover.jpg" alt="Photo by Israel Palacio on Unsplash" />
&lt;/p>
&lt;p>Web APIs are everywhere, with REST being one of the most popular ways to distribute it. With recent technologies, there are better ways to implement them, GRPC been one of them.&lt;/p>
&lt;h1 id="why-rest-is-popular-and-what-are-its-pitfalls">Why REST is popular and what are its pitfalls?&lt;/h1>
&lt;p>Companies used to write web-services in SOAP until REST got enough hype to be the next big thing, although the concept has been around since 2000. It was like a fresh breeze for developers. It had a low learning curve, simplified payload (usually JSON instead of XML), schema-less approach and no need for specific clients/server generators.&lt;/p>
&lt;p>At a certain point, some of its strengths shown to be some of its weaknesses. Not having a schema initially seemed a good idea, but developers eventually realised it is required. It can be useful for validation, documentation, contract agreement between teams and code-generation, to mention a few. Initiatives such as Swagger, RAML and most recently OpenAPI popped up trying to fill these gaps.&lt;/p>
&lt;p>Even though, a lack of an official standard to guide through decision processes usually ended up in analysis paralysis in big projects. Besides, code generation in most of these tools was not as good and ready to use (example: swagger-tools).&lt;/p>
&lt;p>JSON is the preferred way to return data from REST APIs. It is an excellent choice for public services used by front-end applications and third-parties. Due to its overhead on transporting and decoding, it is not well optimised for communication between internal services.&lt;/p>
&lt;p>Even with these issues, it doesn&amp;rsquo;t mean REST is a bad choice. It is by far the simplest way to implement an API, but there are known pitfalls due to its simplicity. Technologies such as GraphQL, Thrift and GRPC come to fill these gaps.&lt;/p>
&lt;h1 id="enters-grpc-and-protocol-buffers">Enters GRPC and Protocol Buffers&lt;/h1>
&lt;p>GRPC is a modern Remote Procedure Call (RPC) framework built on top-off HTTP 2.0, using Protocol Buffers as its interface definition language (IDL). These help it to be a low latency, high performance and scalable option to REST.&lt;/p>
&lt;p>The strict use of HTTP 2.0 enables developers to embrace some of its features, mainly streaming (client-side and server-side). For example:&lt;/p>
&lt;ul>
&lt;li>A client can send a bulk of messages through a stream, instead of sending one request each or one with all of them&lt;/li>
&lt;li>A client can send a request and receive a stream of responses, instead of waiting for the server to finish the processing and send a huge payload&lt;/li>
&lt;/ul>
&lt;p>Protocol Buffers are a simpler and optimised way to define and serialise structured data. It can be used not only with GRPC but for other use cases, such as event modelling and data storage.&lt;/p>
&lt;p>Think Swagger (REST) or WSDL (SOAP), but lightweight due to the fact the payloads are binary, allowing faster serialisation and smaller footprint. Being generated by tools such as &lt;code>protoc&lt;/code>, it brings some benefits such as type checking in compile-time and auto-completion in IDEs.&lt;/p>
&lt;p>In the snippet below, a GRPC service is defined using Protobuf. Generating a client and server requires a simple &lt;code>protoc&lt;/code> call. Easy right?&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-protobuf" data-lang="protobuf">syntax &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;proto3&amp;#34;&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#f92672">package&lt;/span> api;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e">// Defines where your go package will be placed after compilation
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">option&lt;/span> go_package &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;api&amp;#34;&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">service&lt;/span> Identity {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#66d9ef">rpc&lt;/span> GetUser (GetUserRequest) &lt;span style="color:#66d9ef">returns&lt;/span> (GetUserResponse) {}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#66d9ef">rpc&lt;/span> GetUsers (GetUsersRequest) &lt;span style="color:#66d9ef">returns&lt;/span> (GetUsersResponse) {}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">message&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span> {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span> user_id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#66d9ef">bool&lt;/span> active &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">message&lt;/span> &lt;span style="color:#a6e22e">GetUserRequest&lt;/span> {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span> user_id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">message&lt;/span> &lt;span style="color:#a6e22e">GetUserResponse&lt;/span> {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> User user &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">message&lt;/span> &lt;span style="color:#a6e22e">GetUsersRequest&lt;/span> {}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">message&lt;/span> &lt;span style="color:#a6e22e">GetUsersResponse&lt;/span> {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#75715e">// Defines an array of users
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">repeated&lt;/span> User users &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In any protobuf file, each field has a number associated with it. These uniquely identify a position of a field in the binary message, so they shouldnâ€™t be changed. If one of these gets deprecated, they can&amp;rsquo;t be re-used. It helps on avoiding breaking changes, allowing a progressive model evolution. Developers don&amp;rsquo;t need to worry about fields being re-used and clashing with previous payloads of the message.&lt;/p>
&lt;h1 id="creating-a-simple-grpc-server-and-client-in-golang">Creating a simple GRPC server and client in Golang&lt;/h1>
&lt;p>&lt;em>&lt;a href="https://github.com/brunoluiz/grpc-example">Code of this part available at Github brunoluiz/grpc-example@master&lt;/a>&lt;/em>&lt;/p>
&lt;p>It is possible to create a simple GRPC server and client based on the previous protobuf definition. The following tools need to be installed:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/protocolbuffers/protobuf">Protocol buffers compiler&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/golang/protobuf">Golang protoc plugin&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>In a Golang project, running &lt;code>protoc -I. --go_out=plugins=grpc:./generated api/api.proto&lt;/code> will generate both server and client. The &lt;code>go_package&lt;/code> option in the protobuf specifies the generated code output path. In this case it will be &lt;code>./generated/api&lt;/code>.&lt;/p>
&lt;p>To create a server, all methods defined by the proto need to be implemented by a Golang type. Peaking into the generated files, this is the interface generated from &lt;code>service Identity&lt;/code>. A type which implements this interface should be enough to implement the server.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">// File: api/generated/api.pb.go
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">IdentityServer&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> {
&lt;span style="color:#a6e22e">GetUser&lt;/span>(&lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GetUserRequest&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GetUserResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)
&lt;span style="color:#a6e22e">GetUsers&lt;/span>(&lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GetUsersRequest&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GetUsersResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">// File: service/service.go
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">GRPCServer&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> {}
&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">g&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GRPCServer&lt;/span>) &lt;span style="color:#a6e22e">GetUser&lt;/span>(&lt;span style="color:#a6e22e">_&lt;/span> &lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#a6e22e">_&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">api&lt;/span>.&lt;span style="color:#a6e22e">GetUserRequest&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">api&lt;/span>.&lt;span style="color:#a6e22e">GetUserResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>) { &lt;span style="color:#f92672">...&lt;/span> }
&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">g&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GRPCServer&lt;/span>) &lt;span style="color:#a6e22e">GetUsers&lt;/span>(&lt;span style="color:#a6e22e">_&lt;/span> &lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#a6e22e">_&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">api&lt;/span>.&lt;span style="color:#a6e22e">GetUsersRequest&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">api&lt;/span>.&lt;span style="color:#a6e22e">GetUsersResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>) { &lt;span style="color:#f92672">...&lt;/span> }
&lt;/code>&lt;/pre>&lt;/div>&lt;p>With its implementation, the following code will be enough to run it as a server.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">// File: cmd/server/main.go
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#75715e">// Create a new GRPC Server
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">s&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">grpc&lt;/span>.&lt;span style="color:#a6e22e">NewServer&lt;/span>()
&lt;span style="color:#75715e">// Register our service implementation against the GRPC service
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">api&lt;/span>.&lt;span style="color:#a6e22e">RegisterIdentityServer&lt;/span>(&lt;span style="color:#a6e22e">s&lt;/span>, &lt;span style="color:#a6e22e">service&lt;/span>.&lt;span style="color:#a6e22e">NewServer&lt;/span>())
&lt;span style="color:#75715e">// Listen to a specific port
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">lis&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">net&lt;/span>.&lt;span style="color:#a6e22e">Listen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;tcp&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">os&lt;/span>.&lt;span style="color:#a6e22e">Getenv&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;GRPC_ADDRESS&amp;#34;&lt;/span>))
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span>
}
&lt;span style="color:#75715e">// Start serving
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">Serve&lt;/span>(&lt;span style="color:#a6e22e">lis&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>A client will be generated by &lt;code>protoc&lt;/code> as well. It can be created through &lt;code>NewIdentityClient&lt;/code>, returning an &lt;code>IdentityClient&lt;/code> implementation.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">// File: api/generated/api.pb.go
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">IdentityClient&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> {
&lt;span style="color:#a6e22e">GetUser&lt;/span>(&lt;span style="color:#a6e22e">ctx&lt;/span> &lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#a6e22e">in&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GetUserRequest&lt;/span>, &lt;span style="color:#a6e22e">opts&lt;/span> &lt;span style="color:#f92672">...&lt;/span>&lt;span style="color:#a6e22e">grpc&lt;/span>.&lt;span style="color:#a6e22e">CallOption&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GetUserResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)
&lt;span style="color:#a6e22e">GetUsers&lt;/span>(&lt;span style="color:#a6e22e">ctx&lt;/span> &lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#a6e22e">in&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GetUsersRequest&lt;/span>, &lt;span style="color:#a6e22e">opts&lt;/span> &lt;span style="color:#f92672">...&lt;/span>&lt;span style="color:#a6e22e">grpc&lt;/span>.&lt;span style="color:#a6e22e">CallOption&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">GetUsersResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">// File: cmd/client/main.go
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#75715e">// Set up a connection to the server.
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">conn&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">grpc&lt;/span>.&lt;span style="color:#a6e22e">Dial&lt;/span>(&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">String&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;grpc-address&amp;#34;&lt;/span>), &lt;span style="color:#a6e22e">grpc&lt;/span>.&lt;span style="color:#a6e22e">WithInsecure&lt;/span>(), &lt;span style="color:#a6e22e">grpc&lt;/span>.&lt;span style="color:#a6e22e">WithBlock&lt;/span>())
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span>
}
&lt;span style="color:#66d9ef">defer&lt;/span> &lt;span style="color:#a6e22e">conn&lt;/span>.&lt;span style="color:#a6e22e">Close&lt;/span>()
&lt;span style="color:#75715e">// Create GRPC Client
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">client&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">api&lt;/span>.&lt;span style="color:#a6e22e">NewIdentityClient&lt;/span>(&lt;span style="color:#a6e22e">conn&lt;/span>)
&lt;span style="color:#75715e">// Call GRPC Service and Get User
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">u&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">client&lt;/span>.&lt;span style="color:#a6e22e">GetUser&lt;/span>(&lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Background&lt;/span>(), &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">api&lt;/span>.&lt;span style="color:#a6e22e">GetUserRequest&lt;/span>{
&lt;span style="color:#a6e22e">UserId&lt;/span>: &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Args&lt;/span>().&lt;span style="color:#a6e22e">Get&lt;/span>(&lt;span style="color:#ae81ff">0&lt;/span>),
})
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">errors&lt;/span>.&lt;span style="color:#a6e22e">Wrap&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;issue on retrieving users&amp;#34;&lt;/span>)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Of course, this is the bare minimum set-up for a client and server. Interceptors can be added on both client and server, adding custom hooks to any method call and applying some transformations.&lt;/p>
&lt;p>UnaryInterceptors deal with requests which expect a single response back. StreamInterceptors applies to any streamed response or request. &lt;a href="https://davidsbond.github.io/2019/06/14/creating-grpc-interceptors-in-go.html">In this article&lt;/a> by David Bond, there is more information about interceptors and how to implement custom ones.&lt;/p>
&lt;p>Most common interceptors, such as authorisation, validation, monitoring can be found at &lt;a href="https://github.com/grpc-ecosystem/go-grpc-middleware">go-grpc-middleware&lt;/a>. Remember, don&amp;rsquo;t repeat yourself ðŸ˜‰&lt;/p>
&lt;p>&lt;em>&lt;a href="https://github.com/brunoluiz/grpc-example">Code of this part available at Github brunoluiz/grpc-example@master&lt;/a>&lt;/em>&lt;/p>
&lt;h1 id="grpc-and-rest-together-what-is-this-a-crossover-episode">GRPC and REST together: What is this, a crossover episode?&lt;/h1>
&lt;p>&lt;em>&lt;a href="https://github.com/brunoluiz/grpc-example/pull/1">Code of this part available at Github brunoluiz/grpc-example@with-gateway&lt;/a>&lt;/em>&lt;/p>
&lt;p>As previously mentioned, REST simplicity and low learning curve are some of its selling points. It allows quick testing, without the need to set-up a client binary &amp;ndash; who never did a quick &lt;code>curl&lt;/code> to check some API? Besides, it is easier for non-developers to play with it. As it is web services &lt;em>lingua franca,&lt;/em> it might be required for third-party or front-end integrations as well.&lt;/p>
&lt;p>GRPC might be more efficient and better in some cases, but it is not as straightforward to use as REST. What if both could be used together, within the same service? That is where &lt;a href="https://github.com/grpc-ecosystem/grpc-gateway">GRPC Gateway&lt;/a> shines, integrating both worlds in one.&lt;/p>
&lt;p>Through annotations, a service can define which methods will be exposed as REST. Using the previous GRPC protobuf, here is an example &amp;ndash; note the &lt;code>google.api.http&lt;/code> options:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-protobuf" data-lang="protobuf">&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#e6db74">&amp;#34;google/api/annotations.proto&amp;#34;&lt;/span>;&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">service&lt;/span> Identity {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#66d9ef">rpc&lt;/span> GetUser (GetUserRequest) &lt;span style="color:#66d9ef">returns&lt;/span> (GetUserResponse) {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#75715e">// Maps GetUser to an HTTP GET request, with the param `user_id`
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// been mapped to GetUserRequest.user_id
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">option&lt;/span> (google.api.http) &lt;span style="color:#f92672">=&lt;/span> {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> get&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;/v1/users/{user_id}&amp;#34;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> };&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> }&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#66d9ef">rpc&lt;/span> GetUsers (GetUsersRequest) &lt;span style="color:#66d9ef">returns&lt;/span> (GetUsersResponse) {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> &lt;span style="color:#75715e">// Maps GetUsers to an HTTP GET request
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">option&lt;/span> (google.api.http) &lt;span style="color:#f92672">=&lt;/span> {&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> get&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;/v1/users&amp;#34;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> };&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> }&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>}&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>With annotations in place, &lt;code>protoc&lt;/code> needs to be changed to use the &lt;code>grpc-gateway&lt;/code> plugin.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/grpc-ecosystem/grpc-gateway#installation">Install grpc-gateway locally&lt;/a>&lt;/li>
&lt;li>Add GRPC Gateway paths to import paths (&lt;code>-I$(GOPATH)/src/github.com/grpc-ecosystem/grpc-gateway/third\_party/googleapis&lt;/code>)&lt;/li>
&lt;li>Add &lt;code>--grpc-gateway_out=logtostderr=true:./generated&lt;/code> to generate gateway code. It will place at &lt;code>go_package&lt;/code> path&lt;/li>
&lt;li>Add &lt;code>--grpc-swagger_out=logtostderr=true:.&lt;/code> to generate Swagger definitions. It will place it in the same folder as the proto file.&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-makefile" data-lang="makefile">&lt;span style="color:#960050;background-color:#1e0010">protoc&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">-I.&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">-I&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>GOPATH&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">/src&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">-I&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>GOPATH&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>
--grpc-gateway_out&lt;span style="color:#f92672">=&lt;/span>logtostderr&lt;span style="color:#f92672">=&lt;/span>true:./generated &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --swagger_out&lt;span style="color:#f92672">=&lt;/span>logtostderr&lt;span style="color:#f92672">=&lt;/span>true:. &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --go_out&lt;span style="color:#f92672">=&lt;/span>plugins&lt;span style="color:#f92672">=&lt;/span>grpc:./generated &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> api/api.proto
&lt;/code>&lt;/pre>&lt;/div>&lt;p>After running &lt;code>protoc&lt;/code>, the reverse-proxy code will be available for use. It is just a matter of creating an HTTP server for it. The following implementation is running it in a separate server.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">// File: cmd/gateway/main.go
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#75715e">// Note: Make sure the gRPC server is running properly and accessible
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#a6e22e">mux&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">runtime&lt;/span>.&lt;span style="color:#a6e22e">NewServeMux&lt;/span>()
&lt;span style="color:#a6e22e">opts&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> []&lt;span style="color:#a6e22e">grpc&lt;/span>.&lt;span style="color:#a6e22e">DialOption&lt;/span>{&lt;span style="color:#a6e22e">grpc&lt;/span>.&lt;span style="color:#a6e22e">WithInsecure&lt;/span>()}
&lt;span style="color:#75715e">// Register gRPC server endpoint
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">api&lt;/span>.&lt;span style="color:#a6e22e">RegisterIdentityHandlerFromEndpoint&lt;/span>(
&lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Background&lt;/span>(), &lt;span style="color:#a6e22e">mux&lt;/span>, &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">String&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;grpc-address&amp;#34;&lt;/span>), &lt;span style="color:#a6e22e">opts&lt;/span>)
); &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span>
}
&lt;span style="color:#75715e">// Start HTTP reverse proxy: sends calls to GRPC server
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">http&lt;/span>.&lt;span style="color:#a6e22e">ListenAndServe&lt;/span>(&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">String&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;gateway-address&amp;#34;&lt;/span>), &lt;span style="color:#a6e22e">mux&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Any REST client should be able to request data from the Gateway. Server up, this is curl&amp;rsquo;s output:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">âžœ ~ curl localhost:8080/v1/users
&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;user_id&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;xyz&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;Pelican Steve&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;active&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;user_id&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;foo&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;John Doe&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;active&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;user_id&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;bar&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;Chauffina Carr&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;active&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}]}&lt;/span>
âžœ ~ curl localhost:8080/v1/users/xyz
&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;user&amp;#34;&lt;/span>:&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;user_id&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;xyz&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;Pelican Steve&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;active&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}}&lt;/span>
âžœ ~ curl localhost:8080/v1/users/aaa
&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;error&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;resource was not found&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;code&amp;#34;&lt;/span>:5,&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;resource was not found&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>%
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Magic, isn&amp;rsquo;t it? Having this REST set-up might put a smile on some faces. The service can be migrated to GRPC for internal usage, keeping compatibility with REST clients &amp;ndash; third-parties, non-techies and front-end applications.&lt;/p>
&lt;p>&lt;a href="https://www.gophercon.co.uk/videos/2019/writing-rest-services-for-the-grpc-curious/">There is an excellent talk&lt;/a> by Johan Brandhorst giving more details on GRPC Gateway.&lt;/p>
&lt;p>&lt;em>&lt;a href="https://github.com/brunoluiz/grpc-example/pull/1">Code of this part available at Github brunoluiz/grpc-example@with-gateway&lt;/a>&lt;/em>&lt;/p>
&lt;h1 id="fantastic-debugging-tools-and-where-to-find-them">Fantastic debugging tools and where to find them&lt;/h1>
&lt;p>Sooner or later, a quick peek into the service will be required, for debugging or scriptting purposes. In REST this can be done through tools such as curl, Insomnia or Postman. In GRPC, a different set of tools is required.&lt;/p>
&lt;p>For the Graphical Interface lovers, the most popular one is &lt;a href="https://github.com/uw-labs/bloomrpc">BloomRPC&lt;/a>. It only requires the proto files to be loaded and then it works similarly to any other REST client.&lt;/p>
&lt;p>&lt;img loading="lazy" src="https://github.com/uw-labs/bloomrpc/raw/873953c6b00906a69f165c332634b946c7724fe9/resources/editor-preview.gif" alt="BloomRPC demo" />
&lt;/p>
&lt;p>For mouse avoiders &amp;ndash; or terminal lovers ðŸ˜… &amp;ndash; there are two quite useful tools. &lt;a href="https://github.com/fullstorydev/grpcurl">GRPCurl&lt;/a> is an awesome CLI tool, resembling curl and allow easy GRPC automation and scripting. A simple example of its usage follows:&lt;/p>
&lt;p>&lt;code>grpcurl --plaintext --proto api/api.proto localhost:5000 api.Identity/GetUsers&lt;/code>&lt;/p>
&lt;p>&lt;a href="https://github.com/ktr0731/evans">Evans&lt;/a> goes a little bit further, as it has a REPL mode as well, allowing easier resource inspections (my favourite).&lt;/p>
&lt;p>&lt;img loading="lazy" src="https://github.com/ktr0731/evans/raw/97d1de81aa4ea471a14f4db56bf04830c6d79c39/evans1.gif" alt="Evan REPL Demo" />
&lt;/p>
&lt;p>These tools, GUI or not, are quite useful while testing and inspecting GRPC services. Try them and find the one which fits your needs better ðŸ˜‰&lt;/p>
&lt;h1 id="my-experience-using-it">My experience using it&lt;/h1>
&lt;p>In my workplace GRPC has proved quite useful for connecting services, especially internal ones. Protocol Buffers came to be our main IDL when defining contracts for APIs and Stream Events. Due to these contracts, communicating implementations and changes are easier.&lt;/p>
&lt;p>Implementing service clients and servers had been easier and faster. The most common issue is due to include paths errors, which sometimes get messy. But this is more due to our learnings around it than the technology itself. Some of the boilerplate, such as registering the server or dialing the client, can be tackled by creating custom protoc plugins. This proved quite useful, specially when the team is more product-oriented.&lt;/p>
&lt;p>For Golang, it proved to work quite well in most cases, with good community support. But, &lt;code>protoc&lt;/code> can generate code to other languages as well, such as NodeJS and Java. Although, in our NodeJS services, we felt GRPC support is still lacking behind Golang.&lt;/p>
&lt;p>In general, GRPC has been a good choice for our services. Hopefully, it will be good for your team as well.&lt;/p></description></item><item><title>GraphQL feat API Gateway</title><link>https://brunoluiz.net/blog/graphql-as-a-gateway/</link><pubDate>2019-07-01</pubDate><guid>https://brunoluiz.net/blog/graphql-as-a-gateway/</guid><description>&lt;p>&lt;img loading="lazy" src="cover.jpg" alt="Photo by Christian Stahl on Unsplash" />
&lt;/p>
&lt;p>GraphQL, REST, gRPC, Thrift&amp;hellip; Have you ever imagined how to stick these together in a micro-services architecture and expose to the world? There are some common ways to do it, such as using Nginx or Kong. But, an alternative way to do this is by using GraphQL in front of all services.&lt;/p>
&lt;h2 id="api-gateway-pattern----a-quick-introduction">API Gateway pattern &amp;ndash; a quick introduction&lt;/h2>
&lt;p>Consider two services: A and B. How a client would be able to request its data? The easiest way would be to make a request to service A and then another to B, each pointing to a different host (eg: &lt;code>a.service/orders&lt;/code> and &lt;code>b.service/users&lt;/code>).&lt;/p>
&lt;p>As the number of services grows, it is quite laborious to keep using this strategy. Since there could be too many services and requests to coordinate. To solve this, an API proxy can be used, where the client will request to only one service instead of multiple. This proxy will orchestrate where this request should go, glueing all services in one place.&lt;/p>
&lt;p>While proxies just forward requests, API Gateways encapsulate more of the application&amp;rsquo;s internal architecture. Working as a Facade with some other responsibilities, such as:&lt;/p>
&lt;ul>
&lt;li>Request/Response Transformation: requests made by a client can be reshaped before being sent to internal services, with the same applying to responses.&lt;/li>
&lt;li>Request routing: as a proxy, it routes requests to specific services, translating to other protocols if required.&lt;/li>
&lt;li>Composition: one request to the gateway can actually be mapped to multiple internal ones.&lt;/li>
&lt;li>Throttling: limit user requests up to a determined threshold.&lt;/li>
&lt;li>Security: protect some endpoints with some sort of authentication (JWT token, basic, API tokens etc).&lt;/li>
&lt;li>Metrics and Logs: as all requests would pass through it, many metrics and logs will be collected through this service.&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>For more information on the API gateway pattern, take a look at &lt;a href="https://www.nginx.com/blog/building-microservices-using-an-api-gateway/">Nginx micro-services article&lt;/a> and on this &lt;a href="https://freecontent.manning.com/the-api-gateway-pattern/">Chris Richardson article&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;h2 id="why-graphql-and-not-rest">Why GraphQL and not REST?&lt;/h2>
&lt;p>GraphQL was initially developed by Facebook and &lt;a href="https://code.fb.com/core-data/graphql-a-data-query-language/">was open-sourced in 2015&lt;/a>. Many companies started using it for internal APIs, but some are already exposing it as its public API (eg: GitHub, Shopify, Yelp and Contentful).&lt;/p>
&lt;h3 id="schema-validation-and-documentation">Schema validation and documentation&lt;/h3>
&lt;p>With GraphQL, in contrast to from REST, a schema is always required, following &lt;a href="https://graphql.org">GraphQL Foundation&lt;/a> directives. This allows not only schema validation from day one, but documentation too. Typed languages can benefit from the schema and generate type definitions through it (eg: &lt;a href="https://github.com/dotansimha/graphql-code-generator">typescript graphql-code-generator&lt;/a>).&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-graphql" data-lang="graphql">&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Query&lt;/span> {
&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;span style="color:#e6db74"> Fetch posts by user, allowing custom filtering
&lt;/span>&lt;span style="color:#e6db74"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
posts(&lt;span style="color:#66d9ef">input&lt;/span>: &lt;span style="color:#a6e22e">PostQueryInput&lt;/span>): [&lt;span style="color:#a6e22e">Post&lt;/span>]
}
&lt;span style="color:#a6e22e">input&lt;/span> PostQueryInput {
categoryId: &lt;span style="color:#a6e22e">String&lt;/span>
}
&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;span style="color:#e6db74">Post bla bla bla
&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Post&lt;/span> {
title: &lt;span style="color:#a6e22e">String&lt;/span>
categories: [&lt;span style="color:#a6e22e">Category&lt;/span>]
}
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Category&lt;/span> {
name: &lt;span style="color:#a6e22e">String&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In theory, the same could be done with REST by using OpenAPI/Swagger, especially for documentation &lt;del>but YAML, yikes&lt;/del>. But, the code generation tools are not exactly the best and sometimes the schema validation does not work properly, requiring extra middleware and tweaks around it. As GraphQL is standardised in this sense, it doesn&amp;rsquo;t suffer from these issues.&lt;/p>
&lt;h3 id="one-endpoint-to-rule-them-all">One endpoint to rule them all&lt;/h3>
&lt;p>GraphQL only exposes one endpoint. Instead of having N client requests, only one is needed. The server orchestrates everything required to fulfil the whole request, such as: calling multiple micro-services (with any protocol), mapping outputs to the expected schema and logging requests/responses. Besides, this solves &lt;a href="https://stackoverflow.com/questions/44564905/what-is-over-fetching-or-under-fetching/44568365">under-fetching issues&lt;/a>.&lt;/p>
&lt;h3 id="out-of-box-standards">Out-of-box standards&lt;/h3>
&lt;p>REST has been around for a long time, and during this period developers started to have specific necessities, such as sparse fieldsets, versioning, pagination. There are many ways to implement these features but there aren&amp;rsquo;t really any standards (the closest solution is &lt;a href="https://jsonapi.org/">JSONAPI&lt;/a>). GraphQL comes with some of these specs out-of-box:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://graphql.org/learn/queries/#fields">Sparse fieldset&lt;/a>: while making the request, all the required fields need to be specified, avoiding over-fetching&lt;/li>
&lt;li>&lt;a href="https://graphql.org/learn/best-practices/#versioning">Versioning&lt;/a>: route versioning is not a good practice in GraphQL instead, the schema should continually evolve. New capabilities can be inserted on new types and fields, allowing the client to plan and decide when to change to new resolvers. If a field needs to be deprecated, one can use a directive such as &lt;a href="https://www.apollographql.com/docs/graphql-tools/schema-directives">&lt;code>@deprecated&lt;/code>&lt;/a>.&lt;/li>
&lt;li>&lt;a href="https://graphql.org/learn/pagination/">Pagination&lt;/a>: there are some conventions and, for more complex implementations, there is the Connection model pattern.&lt;/li>
&lt;/ul>
&lt;p>Of course, there is other stuff that one can compare against REST, but the idea is to show that GraphQL can be an option.&lt;/p>
&lt;h3 id="developer-experience">Developer experience&lt;/h3>
&lt;p>Front-end and back-end developers can easily settle on a schema and, in a question of minutes, have stubs built around it. Besides, code generation, IDE auto-completion, easy documentation/schema discovery and good API exploring tools (such as GraphQL Playground and GraphiQL) makes the development experience way nicer when compared to REST.&lt;/p>
&lt;h2 id="graphql-as-your-api-gateway">GraphQL as your API Gateway&lt;/h2>
&lt;p>High hopes that you are convinced on trying GraphQL ðŸ™Œ Implementing a GraphQL server is not complicated and there are many guides on the web talking about it. The official website &lt;a href="https://graphql.org/code">has a list with many server frameworks and libraries&lt;/a> (comes in many flavours).&lt;/p>
&lt;p>As mentioned in the first section, an API Gateway has some specific responsibilities. As GraphQL is implemented on top of a normal web server application, one can easily add some of these to it, such as authorisation, metrics and logging. Things such as requests/response transformation, routing and composition are done in the GraphQL resolver level, mapping calls to the right services, using the right communication protocols.&lt;/p>
&lt;blockquote>
&lt;p>Even before going full micro-services and using it as a real API Gateway, companies can easily develop everything on top of a GraphQL monolith &lt;del>wait, don&amp;rsquo;t leave yet&lt;/del> and then, with more time and planning, redirect the resolvers to micro-services. This is particularly useful for small companies, which are still testing ideas. During the migration, back-end might change a lot, but front-end will be able to continue requesting the same stuff.&lt;/p>
&lt;/blockquote>
&lt;p>As teams develop micro-services, a strategy is required to expose and change the public-facing GraphQL schema. There are some known strategies for it:&lt;/p>
&lt;h3 id="remote-schema-stitching">Remote schema stitching&lt;/h3>
&lt;p>The gateway will get the schema from other GraphQL services and then stitch them together as the public-facing schema. This allows more freedom for teams, but it will disperse the API schema through multiple places, making it harder to test and easier to break, with a chance to have merge/stitching conflict.&lt;/p>
&lt;p>Although this can be a problem, teams can do releases without even touching the API Gateway, making the deploys isolated instead of requiring constant API Gateways deploys.&lt;/p>
&lt;blockquote>
&lt;p>Recently, Apollo Server implemented &lt;a href="https://www.apollographql.com/docs/apollo-server/federation/introduction/">Federation&lt;/a>, which will replace remote schema stitching. Bear in mind it is still Apollo specific.&lt;/p>
&lt;/blockquote>
&lt;h3 id="api-gateway-owns-schemas">API Gateway owns schemas&lt;/h3>
&lt;p>The Schema is contained locally on the gateway. This makes development and testing easier, as everything will be in the same place. The caveat is that the service will constantly be modified by multiple teams (resolvers, schemas), requiring constant gateway releases.&lt;/p>
&lt;p>As this service will be constantly modified by multiple people, rules around code formatting and style should be agreed through all teams to make the code uniform.&lt;/p>
&lt;blockquote>
&lt;p>Personally, I prefer this one as it keeps everything in one place, gives high visibility on what is happening and allows easy discovery of other resolvers.&lt;/p>
&lt;/blockquote>
&lt;h3 id="combination-of-both-above">Combination of both above&lt;/h3>
&lt;p>It is possible to mix both strategies, which is especially useful if the team wants to use remote schema stitching but have some services using gRPC or HTTP. Another way to tackle those non-GraphQL services is to put a server in front of it, allowing schema stitching and giving more flexibility for the responsible team.&lt;/p>
&lt;h2 id="caveats-of-using-graphql">Caveats of using GraphQL&lt;/h2>
&lt;h3 id="services-can-get-a-bit-chatty">Services can get a bit chatty&lt;/h3>
&lt;p>On the request below, a user wants all posts with its associated author.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-graphql" data-lang="graphql">&lt;span style="color:#66d9ef">query&lt;/span> {
&lt;span style="color:#a6e22e">posts&lt;/span>(authorId: &lt;span style="color:#e6db74">&amp;#34;bruno&amp;#34;&lt;/span>) {
&lt;span style="color:#a6e22e">title&lt;/span>
author {
name
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The issue is, due to the nature of GraphQL, each resolved &lt;code>post&lt;/code> will call the &lt;code>author&lt;/code> resolver, resulting in &lt;code>N-1&lt;/code> unnecessary calls. Using SQL, it would give us:&lt;/p>
&lt;ul>
&lt;li>&lt;code>Query.posts&lt;/code> are resolved: &lt;code>SELECT title, author_id FROM posts&lt;/code>&lt;/li>
&lt;li>&lt;code>Query.posts&lt;/code> still have un-resolved data about &lt;code>Post.author.name&lt;/code>. For each item, GraphQL will call &lt;code>Post.author&lt;/code> resolver&lt;/li>
&lt;li>Post A calls &lt;code>Post.author&lt;/code> resolver: &lt;code>SELECT * FROM authors WHERE author_id = 'bruno'&lt;/code>&lt;/li>
&lt;li>Post B calls &lt;code>Post.author&lt;/code> resolver again with the same query&lt;/li>
&lt;li>Post C calls &lt;code>Post.author&lt;/code> resolver again with the same query&lt;/li>
&lt;li>&amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>The two first selects would have returned the required data, but due to how GraphQL resolvers work &amp;ndash; each resolved item with missing data calls the subsequent resolver &amp;ndash; all these extra calls are made. This is where the &lt;a href="https://github.com/graphql/dataloader">DataLoader&lt;/a> pattern shines.&lt;/p>
&lt;p>Using batching and a cache (per-request only), it will lead your back-end only needing to make the right amount of calls. Probably even saving you from more calls, as the &lt;code>author&lt;/code> could have other resolvers to be called. In the previous example it would do something like:&lt;/p>
&lt;ul>
&lt;li>&lt;code>Query.posts&lt;/code> are resolved: &lt;code>SELECT title, author_id FROM posts&lt;/code>.&lt;/li>
&lt;li>&lt;code>Query.posts&lt;/code> still have un-resolved data about &lt;code>Post.author.name&lt;/code>. For each item, the service would add a call to DataLoader with the required &lt;code>author_id&lt;/code>.&lt;/li>
&lt;li>After passing through all items, DataLoader would only execute &lt;code>SELECT * FROM authors WHERE author_id = 'bruno'&lt;/code> query and return the response.&lt;/li>
&lt;/ul>
&lt;p>The JavaScript implementation is under 400 LOC, making it easier to explore and understand how it actually works. &lt;a href="https://github.com/graphql/dataloader/blob/master/README.md#other-implementations">There are implementations in other languages as well&lt;/a>.&lt;/p>
&lt;blockquote>
&lt;p>MPJ, from FunFunFunction, released a &lt;a href="https://www.youtube.com/watch?v=lAJWHHUz8_8&amp;amp;list=PL0zVEGEvSaeEjIDdbK1KfR7V9XBCVAr0P">video series&lt;/a> on how to implement GraphQL in NodeJS. &lt;a href="https://www.youtube.com/watch?v=--AguZ20lLA&amp;amp;list=PL0zVEGEvSaeEjIDdbK1KfR7V9XBCVAr0P&amp;amp;index=3">Watch the DataLoader video here&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;h3 id="throttling-is-not-easy-as-rest">Throttling is not easy as REST&lt;/h3>
&lt;p>Having everything in one endpoint makes harder to properly implement rate limits because the queries can be quite complex with multiple underlying requests but still one client request. This means an API user can&amp;rsquo;t be limited through its number of calls to a certain endpoint anymore.&lt;/p>
&lt;p>An approach to tackle this is by calculating the query complexity and using it as a rate limit score. &lt;a href="https://developer.github.com/v4/guides/resource-limitations/">On GitHub API docs&lt;/a>, there are examples of how it works. But, this doesn&amp;rsquo;t come out-of-box in most server implementations ðŸ˜ž There are some packages such as &lt;a href="https://github.com/4Catalyzer/graphql-validation-complexity">&lt;code>graphql-validation-complexity&lt;/code>&lt;/a> and &lt;a href="https://github.com/pa-bru/graphql-cost-analysis">&lt;code>graphql-cost-analysis&lt;/code>&lt;/a>, where the latter is more advanced, with more options to limit the upcoming queries.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-graphql" data-lang="graphql">&lt;span style="color:#75715e"># Usage example of graphql-cost-analysis&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Query&lt;/span> {
&lt;span style="color:#75715e"># the cost will depend on the `limit` parameter passed to the field&lt;/span>
&lt;span style="color:#75715e"># then the multiplier will be added to the `parent multipliers` array&lt;/span>
customCostWithResolver(limit: &lt;span style="color:#a6e22e">Int&lt;/span>): &lt;span style="color:#a6e22e">Int&lt;/span>
&lt;span style="color:#a6e22e">@cost&lt;/span>(multipliers: [&lt;span style="color:#e6db74">&amp;#34;limit&amp;#34;&lt;/span>], &lt;span style="color:#a6e22e">complexity&lt;/span>: &lt;span style="color:#a6e22e">4&lt;/span>)
&lt;span style="color:#75715e"># for recursive cost&lt;/span>
first(limit: &lt;span style="color:#a6e22e">Int&lt;/span>): &lt;span style="color:#a6e22e">First&lt;/span>
&lt;span style="color:#a6e22e">@cost&lt;/span>(multipliers: [&lt;span style="color:#e6db74">&amp;#34;limit&amp;#34;&lt;/span>], &lt;span style="color:#a6e22e">useMultipliers&lt;/span>: &lt;span style="color:#a6e22e">true&lt;/span>, complexity: &lt;span style="color:#a6e22e">2&lt;/span>)
&lt;span style="color:#75715e"># You can specify several field parameters in the `multipliers` array&lt;/span>
&lt;span style="color:#75715e"># then the values of the corresponding parameters will be added together.&lt;/span>
&lt;span style="color:#75715e"># here, the cost will be `parent multipliers` * (`first` + `last`) * `complexity&lt;/span>
severalMultipliers(first: &lt;span style="color:#a6e22e">Int&lt;/span>, last: &lt;span style="color:#a6e22e">Int&lt;/span>): &lt;span style="color:#a6e22e">Int&lt;/span>
&lt;span style="color:#a6e22e">@cost&lt;/span>(multipliers: [&lt;span style="color:#e6db74">&amp;#34;first&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;last&amp;#34;&lt;/span>])
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="caching-is-magic-until-it-isnt">Caching is magic until it isn&amp;rsquo;t&lt;/h3>
&lt;p>Most clients do caching automatically, but sometimes it doesn&amp;rsquo;t work as expected, requiring some manual cleaning on the client. Besides, each request might ask for different fields, which makes a bit trickier to cache a resource on the server-side. One might request the whole resource, cache it in memory (eg: Redis), and then allow the API to use it as a reference to select specific fields.&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>Hopefully, this might have clarified some details of using GraphQL as an API gateway. For those who want to go deeper, there are some references below, from where I took notes for this post.&lt;/p>
&lt;p>Many thanks for &lt;a href="https://www.southcla.ws/">@southclaws&lt;/a>, &lt;a href="http://michalbock.com/">@SpeedyCoder&lt;/a>, &lt;a href="https://github.com/cassiobock">@cassiobock&lt;/a> and &lt;a href="https://www.codepreneur.io/">@codepreneur&lt;/a> for helping me by reviewing this post.&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;h4 id="api-gateway">API Gateway&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://www.nginx.com/blog/building-microservices-using-an-api-gateway/">Ngnix micro-services book chapter about API Gateway&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://freecontent.manning.com/the-api-gateway-pattern/">Chris Richardson article about API Gateway&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stoplight.io/blog/api-proxy-vs-api-gateway-c008c942a02d/">API Proxy vs API Gateway&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://microservices.io/patterns/apigateway.html">Pattern: API Gateway / Back-end for Front-End&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="graphql">GraphQL&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://graphql.org/learn/">GraphQL Documentation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developer.github.com/v4/guides/resource-limitations/">GitHub GraphQL Resource Limitations Documentation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tomasalabes.me/blog/graphql/node/microservices/2018/08/11/graphql-architectures.html">GraphQL Gateway Architectures&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.robinwieruch.de/why-graphql-advantages-disadvantages-alternatives/">Why GraphQL: Advantages, Disadvantages &amp;amp; Alternatives&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://webapplog.com/graphql/">Why GraphQL is Taking Over APIs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.apollographql.com/docs/graphql-tools/schema-stitching">Schema stitching &amp;ndash; Combining multiple GraphQL APIs into one&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.apollographql.com/apollo-federation-f260cf525d21">Apollo Federation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.youtube.com/watch?v=lAJWHHUz8_8&amp;amp;list=PL0zVEGEvSaeEjIDdbK1KfR7V9XBCVAr0P">FunFunFunction GraphQL Videos&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="tools">Tools&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/dotansimha/graphql-code-generator">Typescript &lt;code>graphql-code-generator&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/graphql/dataloader">DataLoader&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/4Catalyzer/graphql-validation-complexity">&lt;code>graphql-validation-complexity&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/pa-bru/graphql-cost-analysis">&lt;code>graphql-cost-analysis&lt;/code>&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="images">Images&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://unsplash.com/photos/8S96OpxSlvg">Cover Photo by Christian Stahl on Unsplash&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="other">Other&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://jsonapi.org/">JSONAPI: REST alternative to GraphQL&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/questions/44564905/what-is-over-fetching-or-under-fetching/44568365">What is over and under-fetching&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Kubernetes devops productivity hacks</title><link>https://brunoluiz.net/blog/2019/mar/kubernetes-devops-productivity-hacks/</link><pubDate>2019-03-14</pubDate><guid>https://brunoluiz.net/blog/2019/mar/kubernetes-devops-productivity-hacks/</guid><description>&lt;p>&lt;img loading="lazy" src="cover.jpg" alt="Photo by Cameron Venti on Unsplash" />
&lt;/p>
&lt;p>Today, Kubernetes is the de facto container orchestration solution. Together with the devops culture, developers have to get familiarised to its tools, such as &lt;code>kubectl&lt;/code>.&lt;/p>
&lt;p>After some point though, using &lt;code>kubectl&lt;/code> for everything can get quite verbose, especially if you use many namespaces and contexts. The following tips try to minimise the pain of doing operations solely through it, sometimes even using other tools beside it.&lt;/p>
&lt;h2 id="kubectx-context-and-namespaces-management">Kubectx: context and namespaces management&lt;/h2>
&lt;p>Operations done in &lt;code>kubectl&lt;/code> usually require two params: &lt;strong>context&lt;/strong> and &lt;strong>namespace&lt;/strong>. Any operation will result in something as &lt;code>kubectl --context dev --namespace hello-world exec -it hello-world-app-0 sh&lt;/code>. It is fine for a one-time operation, but after some point, it can get quite cumbersome. One way to avoid these long command strings is by using &lt;a href="https://github.com/ahmetb/kubectx">&lt;code>kubectx&lt;/code>&lt;/a>.&lt;/p>
&lt;p>After installing it, the context can be set by simply using &lt;code>kubectx dev&lt;/code> and the namespace as &lt;code>kubens hello-world&lt;/code>. To list the available contexts and namespaces, just run it without arguments. The above operation can be run by only using &lt;code>kubectl exec -it hello-world-app-0 sh&lt;/code>.&lt;/p>
&lt;h2 id="terminal-aliases">Terminal aliases&lt;/h2>
&lt;p>Seasoned Unix developers are quite used to terminal aliases. Some are quite popular that are even grouped in packs, such as &lt;a href="https://github.com/robbyrussell/oh-my-zsh/blob/master/plugins/git/git.plugin.zsh">oh-my-zsh git aliases&lt;/a>. With Kubernetes is not that different.&lt;/p>
&lt;p>Usually, having &lt;code>alias k=&amp;quot;kubectl&amp;quot;&lt;/code> already make operations shorter. Using the same example, it would result in &lt;code>k exec -it hello-world-app-0 sh&lt;/code>. But, most likely, one alias will not be enough. There are some options for this.&lt;/p>
&lt;p>The first one can be set-up in any terminal emulator (&lt;code>zsh&lt;/code>, &lt;code>bash&lt;/code>&amp;hellip;). Get the &lt;code>.kubectl_aliases&lt;/code> file from &lt;a href="https://github.com/ahmetb/kubectl-aliases">&lt;code>ahmetb/kubectl-aliases&lt;/code>&lt;/a> and place it in your home directory. After sourcing it on &lt;code>.zshrc&lt;/code> or &lt;code>.bashrc&lt;/code>, 600 aliases will be available out-of-box, including the aforementioned &lt;code>k&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#f92672">[&lt;/span> -f ~/.kubectl_aliases &lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> source ~/.kubectl_aliases
&lt;/code>&lt;/pre>&lt;/div>&lt;p>If &lt;a href="http://zsh.sourceforge.net/">&lt;code>zsh&lt;/code>&lt;/a> and &lt;a href="https://ohmyz.sh/">&lt;code>oh-my-zsh&lt;/code>&lt;/a> are already set-up, an easier option would be to use the pre-installed &lt;code>kubectl&lt;/code> plugin. To enable it, edit your &lt;code>.zshrc&lt;/code> and add &lt;code>kubectl&lt;/code> to the &lt;code>plugins&lt;/code> variable (&lt;a href="https://github.com/robbyrussell/oh-my-zsh#plugins">more details about oh-my-zsh plugins here&lt;/a>).&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">plugins&lt;span style="color:#f92672">=(&lt;/span>git kubectl ...&lt;span style="color:#f92672">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>There are fewer aliases compared to &lt;code>ahmetb/kubectl-aliases&lt;/code>, making it easier to learn and faster to load. The list of &lt;code>oh-my-zsh/kubectl&lt;/code> aliases is &lt;a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/kubectl"> available here &lt;/a>&lt;/p>
&lt;p>&lt;code>kubectx&lt;/code> and &lt;code>kubens&lt;/code> do not have aliases by default. To allow shorter calls for it, place the following on &lt;code>.zshrc&lt;/code> or &lt;code>.bashrc&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">alias kns&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubens&amp;#34;&lt;/span>
alias kcx&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubectx&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>After all these aliases been set-up, the &lt;code>hello-world-app-0 sh&lt;/code> can be accessed using a simple &lt;code>keti hello-world-app-0 sh&lt;/code>. As games, it will be as learning combat combos, although it will not be as close as a Hadouken combo.&lt;/p>
&lt;h2 id="terminal-namespace-and-context-indicator">Terminal namespace and context indicator&lt;/h2>
&lt;p>Developers are humans (in case you did not know) and humans do not have bulletproof memory. One can forget that kubernetes context is set to production and then run &lt;code>kubectl apply&lt;/code> there, instead of dev.&lt;/p>
&lt;p>To avoid this, an indicator can be used in the terminal to show what is the actual context and namespace. The easiest way to do it is by using &lt;a href="https://github.com/jonmosco/kube-ps1">&lt;code>kube-ps1&lt;/code>&lt;/a>. It already comes with &lt;code>oh-my-zsh&lt;/code>, requiring &lt;code>kube-ps1&lt;/code> to be added to &lt;code>.zshrc&lt;/code> plugins variable.&lt;/p>
&lt;p>After installing or enabling it, the PS1 needs to be changed to include the kubectl context and namespace information. This can be easily done by adding &lt;code>export PS1='$(kube_ps1) '$PS1&lt;/code> to your &lt;code>.bashrc/.zshrc&lt;/code> file. The final result will be something like the following.&lt;/p>
&lt;p>&lt;img loading="lazy" src="kube-ps1.png" alt="kube-ps1 example" />
&lt;/p>
&lt;p>The only issue with &lt;code>kube-ps1&lt;/code> is, when used with &lt;code>git&lt;/code> plugin in zsh, it can generate really long PS1 strings. If &lt;code>tmux&lt;/code> is used, it can be actually set-up in the status bar through &lt;a href="https://github.com/jonmosco/kube-tmux">&lt;code>kube-tmux&lt;/code>&lt;/a> plugin, avoiding PS1 cluttering.&lt;/p>
&lt;p>&lt;img loading="lazy" src="kube-tmux-ps1.png" alt="kube-tmux example" />
&lt;/p>
&lt;h2 id="investigating-logs-the-sane-way">Investigating logs: the sane way&lt;/h2>
&lt;p>Failures can happen, debugs are required and check-ups are sometimes necessary. For all of these, application logs are needed. The standard way to open them is:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl --namespace dev --context labs get pods
&lt;span style="color:#75715e"># get the pod id&lt;/span>
kubectl --namespace dev --context labs logs &amp;lt;pod-id&amp;gt; -f
&lt;/code>&lt;/pre>&lt;/div>&lt;p>If the pod is killed and restarted, the process has to be repeated as the pod id will change. Besides, the &lt;code>kubectl&lt;/code> logs tool is quite simple in terms of features. &lt;a href="https://github.com/wercker/stern">&lt;code>stern&lt;/code>&lt;/a> is meant to be more powerful and allows to tail multiple pods and containers at once (even the whole namespace, if required).&lt;/p>
&lt;p>To tail pods, such as the hello-world example, &lt;code>stern hello-world&lt;/code> will do. It would tail everything using the &lt;code>*hello-world*&lt;/code> as an expression. If multiple pods were been run, it would log all hello-world pods.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">stern hello-world &lt;span style="color:#75715e"># tail all pods containing &amp;#34;hello-world&amp;#34; in its name&lt;/span>
stern . &lt;span style="color:#75715e"># tail all pods in current namespace&lt;/span>
stern --since 1h . &lt;span style="color:#75715e"># tail logs from last one hour&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Shorter calls can be done setting up an alias, such as &lt;code>alias s='stern'&lt;/code>. If set, it uses the &lt;code>kubectx&lt;/code> and &lt;code>kubens&lt;/code> settings, while accepting &lt;code>--namespace&lt;/code> and &lt;code>--context&lt;/code> args as well.&lt;/p>
&lt;h2 id="automatic-deployments">Automatic deployments&lt;/h2>
&lt;p>A way to avoid touching prod environment using &lt;code>kubectl&lt;/code> is by setting up &lt;a href="https://github.com/box/kube-applier">&lt;code>kube-applier&lt;/code>&lt;/a>. This service auto-deploy changes on infrastructure changes, based on a git repository.&lt;/p>
&lt;p>It runs as a separate pod, watching and comparing kubernetes manifest repository with deployed services. If there is a difference between manifests, it will automatically apply what is in the git repository, making it the source of truth for kube manifests.&lt;/p>
&lt;p>After installing &lt;code>kube-applier&lt;/code>, no deploys should be done through &lt;code>kubectl&lt;/code>, as it will always revert to git manifests. This avoids confusions around deployments made in a rush, not merged and then rollbacked by a mistake.&lt;/p>
&lt;h2 id="add-safety-against-wrong-kubectl-apply">Add safety against wrong kubectl apply&lt;/h2>
&lt;p>If &lt;code>kube-applier&lt;/code> is not an option, perhaps it would be good to have a protection before &lt;code>kubectl apply&lt;/code> operations. There are many ways to do this, the following considers overwriting &lt;code>kaf&lt;/code> from &lt;code>oh-my-zsh&lt;/code> plugin. It adds a confirmation prompt and shows which context it will be applied to.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#75715e"># Confirm command to be executed&lt;/span>
confirm&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
echo -n &lt;span style="color:#e6db74">&amp;#34;\e[33mDo you want to run &lt;/span>$*&lt;span style="color:#e6db74">? [N/yes] \e[m&amp;#34;&lt;/span>
read REPLY
&lt;span style="color:#75715e"># if test &amp;#34;$REPLY&amp;#34; = &amp;#34;y&amp;#34; -o &amp;#34;$REPLY&amp;#34; = &amp;#34;Y&amp;#34;; then&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> test &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$REPLY&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;yes&amp;#34;&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$@&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">else&lt;/span>
echo &lt;span style="color:#e6db74">&amp;#34;Cancelled by user&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
safe_kubectlapply&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
context&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>kubectl config current-context&lt;span style="color:#66d9ef">)&lt;/span>
echo &lt;span style="color:#e6db74">&amp;#34;\n&amp;#34;&lt;/span>
echo &lt;span style="color:#e6db74">&amp;#34;BECAREFUL!!! APPLYING TO \e[31m&lt;/span>$context&lt;span style="color:#e6db74">\e[m&amp;#34;&lt;/span>
confirm kubectl apply -f &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$@&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
alias kaf&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;safe_kubectlapply&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This can pottentially save lifes. It can be modified to be used with other operations, such as &lt;code>kdel&lt;/code> and &lt;code>kdelf&lt;/code> (aliases for &lt;code>kubectl delete&lt;/code>).&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>These are just some tricks I use in my daily kubernetes life. Have a good coding week! ðŸ˜‰&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>Cover photo by &lt;a href="https://unsplash.com/photos/QtETdXXR7gs?utm_source=unsplash&amp;amp;utm_medium=referral&amp;amp;utm_content=creditCopyText">Cameron Venti&lt;/a> on Unsplash&lt;/li>
&lt;li>&lt;a href="https://github.com/ahmetb/kubectx">&lt;code>kubectx&lt;/code> repo&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/ahmetb/kubectl-aliases">&lt;code>ahmetb/kubectl-aliases&lt;/code> repo&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/robbyrussell/oh-my-zsh">&lt;code>oh-my-zsh&lt;/code> repo&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/kubectl">&lt;code>oh-my-zsh&lt;/code> kubectl info&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/jonmosco/kube-ps1">&lt;code>kube-ps1&lt;/code> repo&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/kube-ps1">&lt;code>oh-my-zsh&lt;/code> kube-ps1 info&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/jonmosco/kube-tmux">&lt;code>kube-tmux&lt;/code> repo&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/wercker/stern">&lt;code>stern&lt;/code> repo&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/box/kube-applier">&lt;code>kube-applier&lt;/code> repo&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>A guide on npm package publishing</title><link>https://brunoluiz.net/blog/2019/feb/a-guide-to-npm-package-publishing/</link><pubDate>2019-02-15</pubDate><guid>https://brunoluiz.net/blog/2019/feb/a-guide-to-npm-package-publishing/</guid><description>&lt;p>&lt;img loading="lazy" src="cover.jpg" alt="Photo by Paul Esch-Laurent on Unsplash" />
&lt;/p>
&lt;p>If you are not new in the JavaScript world, you might have already heard about &lt;a href="https://www.npmjs.com/">npm&lt;/a>. It is a package manager which lets developers easily add dependencies to projects, as &lt;code>npm install hello-world&lt;/code>. But, have you ever asked, &amp;ldquo;How do I create and publish my own packages&amp;rdquo;?&lt;/p>
&lt;h2 id="how-a-package-is-composed">How a package is composed?&lt;/h2>
&lt;p>Packages are quite simple to create in JavaScript. A &lt;code>package.json&lt;/code> and &lt;code>index.js&lt;/code> can already do the job. Look at &lt;code>dedupe&lt;/code> for example:&lt;/p>
&lt;p>&lt;img loading="lazy" src="dedupe.png" alt="dedupe repository" />
&lt;/p>
&lt;p>There are other useful files such as &lt;code>.gitignore&lt;/code>, &lt;code>.npmignore&lt;/code>, &lt;code>LICENSE&lt;/code> and &lt;code>README.md&lt;/code>, but the main ones are there: &lt;code>package.json&lt;/code> and &lt;code>index.js&lt;/code>. Having these, the package just needs to be published in a repository, such as the &lt;a href="https://www.npmjs.com/">npm public&lt;/a>. Through this guide, you will be able to have a simple package published on npm.&lt;/p>
&lt;h2 id="create-an-npm-package">Create an npm package&lt;/h2>
&lt;p>While doing &lt;a href="https://apimock.in">apimock.in&lt;/a>, I had to create multiple serverless stacks. Each had error handlers and, as most of the errors are quite the same, a good practice would be to extract these definitions into a package and just install it on each serverless stack. This use case will be used as an example through this post.&lt;/p>
&lt;h3 id="create-an-npmjscom-account">Create an npmjs.com account&lt;/h3>
&lt;p>Before doing anything, an account on &lt;a href="https://npmjs.com">npmjs.com&lt;/a> is required for publishing a package. This is the website for the npm public repository, used when &lt;code>npm install ...&lt;/code> is executed.&lt;/p>
&lt;p>To create an account, go to the &lt;a href="https://www.npmjs.com/signup">npm signup page&lt;/a> and fill up the form. After finishing the process, a test can be done using &lt;code>npm login&lt;/code> and &lt;code>npm whoami&lt;/code>. Has it output your username? Great! It is working!&lt;/p>
&lt;!-- ![](https://cdn-images-1.medium.com/max/1600/1*sUm176ELamVqjUF1GUpiVw.gif) -->
&lt;h3 id="some-words-about-scopes">Some words about scopes&lt;/h3>
&lt;p>Scopes are useful in many ways, although not strictly required to publish an npm package. Every user has its own scope, defined as the npm user name.&lt;/p>
&lt;p>As only the developer/company can publish to its own scope, it is quite useful to indicate it is an official package. For example, one can publish a package called &lt;code>xyz-sdk&lt;/code>, but another called &lt;code>xyz&lt;/code> might already exist. How to know which to install? What if &lt;code>xyz&lt;/code> mimics &lt;code>xyz-sdk&lt;/code>, but with malicious code?&lt;/p>
&lt;blockquote>
&lt;p>Each npm user/organisation has their own scope, and only you can add packages in your scope. This means you donâ€™t have to worry about someone taking your package name ahead of you. Thus it is also a good way to signal official packages for organisations. (&lt;a href="https://docs.npmjs.com/misc/scope">from npm-scopes documentation&lt;/a>)&lt;/p>
&lt;/blockquote>
&lt;p>A scoped package would have an &lt;code>@account&lt;/code> prefix. It would be published as &lt;code>@account/xyz-sdk&lt;/code>, hence easily identifiable as from a specific developer. Besides, the developer doesn&amp;rsquo;t have to worry about name clashing, as the scope is account specific. It can be configured to point to a private repository as well, making it especially useful for companies.&lt;/p>
&lt;p>There is &lt;a href="https://docs.npmjs.com/misc/scope">more information about scopes here&lt;/a>. Keep in mind it is a good practice to scope packages.&lt;/p>
&lt;h3 id="create-a-simple-structure">Create a simple structure&lt;/h3>
&lt;p>In an empty folder, run &lt;code>npm init â€”-scope=@your-npm-user&lt;/code>. This will setup a &lt;code>package.json&lt;/code> and ask for some information, such as name, version, main entry file and author. The end result will be something like the following.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;@brunoluiz/jsonapi-errors&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;version&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;1.0.0&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;JSONAPI Common Errors&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;main&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;index.js&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;scripts&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;test&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;jest&amp;#34;&lt;/span>
},
&lt;span style="color:#f92672">&amp;#34;author&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Bruno Luiz da Silva &amp;lt;contact@brunoluiz.net&amp;gt; (http://brunoluiz.net/)&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;license&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;MIT&amp;#34;&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>After having it initialised, is time to code something. Develop a basic implementation of it in the specified main file on &lt;code>npm init&lt;/code> setup (usually &lt;code>index.js&lt;/code>). If the package requires dependencies or there are files to be ignored on publishing, specify it on a &lt;code>.gitignore&lt;/code> file (eg: &lt;code>node_modules&lt;/code>).&lt;/p>
&lt;p>It is suggested to add a &lt;code>LICENSE.md&lt;/code> and a &lt;code>README.md&lt;/code>, as other developers might use this package. Usually, MIT or ISC licenses are fine to open-source projects, but &lt;a href="https://choosealicense.com/">choosealicense.com&lt;/a> can help on choosing another license.&lt;/p>
&lt;h3 id="publish-the-package">Publish the package&lt;/h3>
&lt;p>The basic implementation is done and now is time to deploy it! On the first time, a &lt;code>npm publish --access=public&lt;/code> is required. The &lt;code>access=public&lt;/code> param is needed because scoped are &lt;code>restricted&lt;/code> by default. On following publishings, a &lt;code>npm publish&lt;/code> will do the job.&lt;/p>
&lt;p>Congratulations! You published your first package on npm. It should be available at &lt;code>https://npmjs.com/package/@your-npm-user/package-name&lt;/code> and ready to be installed through &lt;code>npm install @your-npm-user/package-name&lt;/code>.&lt;/p>
&lt;!-- ![](https://cdn-images-1.medium.com/max/1600/1*oltzIY-eP8kDiK7mIlUVIQ.gif) -->
&lt;p>&lt;img loading="lazy" src="npm_published_module.png" alt="Published package" />
&lt;/p>
&lt;h3 id="releasing-new-versions">Releasing new versions&lt;/h3>
&lt;p>After some iterations, the package might need new features and, therefore a new version. NPM packages use semantic versioning (&lt;a href="https://semver.org/">SEMVER&lt;/a>), but in a nutshell:&lt;/p>
&lt;blockquote>
&lt;p>MAJOR version when you make incompatible API changes,&lt;/p>
&lt;p>MINOR version when you add functionality in a backwards-compatible manner, and&lt;/p>
&lt;p>PATCH version when you make backwards-compatible bug fixes.&lt;/p>
&lt;/blockquote>
&lt;p>In the &lt;code>jsonapi-errors&lt;/code> example, a minor version increment is required. To do this, a &lt;code>npm version minor&lt;/code> can be used, where it will bump the &lt;code>package.json&lt;/code> version and add a tagged git commit. Then, a &lt;code>npm publish&lt;/code> will take care of pushing it (no need for &lt;code>access&lt;/code> parameter now). The version tags can be checked using &lt;code>git log --decorate --oneline&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">b874866 &lt;span style="color:#f92672">(&lt;/span>HEAD -&amp;gt; master, tag: v0.2.0&lt;span style="color:#f92672">)&lt;/span> 0.2.0
c5af2df chore: add new implementations
b8571cc &lt;span style="color:#f92672">(&lt;/span>tag: v0.1.0&lt;span style="color:#f92672">)&lt;/span> 0.1.0
c5bf2ef chore: initial commit
&lt;/code>&lt;/pre>&lt;/div>&lt;p>There are &lt;a href="https://docs.npmjs.com/cli/version.html">more information about the versioning process here&lt;/a>.&lt;/p>
&lt;!-- ![](https://cdn-images-1.medium.com/max/1600/1*gg3mGMbiQMFB7FKQQi8NzQ.gif) -->
&lt;h3 id="using-in-local-projects-through-linking">Using in local projects through linking&lt;/h3>
&lt;p>A simple way to test the new shiny package is through &lt;code>npm install&lt;/code>. It will work as expected but, if a change is required, a new version has to be published and the project dependency has to be upgraded to use the new one.&lt;/p>
&lt;p>This is unproductive, especially when a package is new and changes happen quite often. A way to solve it is through &lt;code>npm link&lt;/code>: it creates a symbolic link inside the project &lt;code>node_modules&lt;/code> folder, replacing the installed version with the local one.&lt;/p>
&lt;p>In the module folder, run &lt;code>npm link&lt;/code>, which will enable a global link for it. On the project folder, run &lt;code>npm link &amp;lt;name&amp;gt;&lt;/code>. If the module is modified, projects using it through a link will have the latest version of it.&lt;/p>
&lt;p>After testing, two steps are required to remove it. The first is running &lt;code>npm unlink --no-save &amp;lt;name&amp;gt;&lt;/code>, which removes the link from the project without touching &lt;code>package.json&lt;/code>. The second is &lt;code>npm install&lt;/code>, as the module is removed from &lt;code>node_modules&lt;/code> after unlinking.&lt;/p>
&lt;p>Removing the global link is not required, especially because it can be used later. If still needed, a &lt;code>npm unlink&lt;/code> in the module folder will do it.&lt;/p>
&lt;h2 id="automate-publishing-process-using-circleci">Automate publishing process using CircleCI&lt;/h2>
&lt;p>If a package has many people collaborating to it, or the deploy process requires extra steps beside publishing it, an automated setup can improve the workflow. There are plenty of options, such as CircleCI, Travis and GitLab CI.&lt;/p>
&lt;p>On CircleCI Blog there is an &lt;a href="https://circleci.com/blog/publishing-npm-packages-using-circleci-2-0/">article explaining in details how to do it&lt;/a>, where:&lt;/p>
&lt;ol>
&lt;li>On feature branches, it will just run tests (eg: run tests on pull requests)&lt;/li>
&lt;li>On git &lt;code>v*.*.*&lt;/code> tag pushes, it will run tests and then publish to the NPM repository â€” remembering, a git version tag is generated by &lt;code>npm version&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>More configurations can be added, such as saving coverage reports to a bucket or triggering specific web hooks after the jobs (eg: Slack).&lt;/p>
&lt;h2 id="setup-default-npm-init-configs">Setup default npm init configs&lt;/h2>
&lt;p>Starting a package with &lt;code>npm init&lt;/code> is fine, but repeating the same information over and over can get quite boring. &lt;code>npm config&lt;/code> can be used to setup some default configs:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">npm config set init-author-name&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;Bruno Luiz da Silva&amp;#39;&lt;/span>
npm config set init-author-email&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;contact@brunoluiz.net&amp;#39;&lt;/span>
npm config set init-author-url&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;https://brunoluiz.net&amp;#39;&lt;/span>
npm config set init-license&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;MIT&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>These are saved at &lt;code>~/.npmrc&lt;/code>, together with other user configs.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#75715e"># ~/.npmrc&lt;/span>
init-author-name&lt;span style="color:#f92672">=&lt;/span>Bruno Luiz da Silva
init-author-email&lt;span style="color:#f92672">=&lt;/span>contact@brunoluiz.net
init-author-url&lt;span style="color:#f92672">=&lt;/span>http://brunoluiz.net/
init-version&lt;span style="color:#f92672">=&lt;/span>1.0.0
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, a simple &lt;code>npm init -y&lt;/code> can be used to create packages. It will not ask for user input, using the npm configs instead and &lt;code>@&amp;lt;scope&amp;gt;/&amp;lt;folder-name&amp;gt;&lt;/code> as the name.&lt;/p>
&lt;p>There are many other configs available through it. Besides, projects can have their own specific configs and even environment variables can be used for it. Check &lt;a href="https://docs.npmjs.com/misc/config">the npm documentation&lt;/a> for more details.&lt;/p>
&lt;h2 id="where-to-go-now">Where to go now?&lt;/h2>
&lt;p>The steps shown in this article will cover most basic necessities on npm package publishing, but there are some specifics I haven&amp;rsquo;t covered in this article.&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Publish the package as TypeScript:&lt;/strong> this allows code typing, more robust codes and, in editors such as VS Code, it enables a batter IntelliSense. &lt;a href="https://itnext.io/step-by-step-building-and-publishing-an-npm-typescript-package-44fe7164964c">There is a quite complete article on
ITNext&lt;/a>.&lt;/li>
&lt;li>&lt;strong>Publish it to a private repository:&lt;/strong> there are some small different configurations, as pointing the package scope to the private repository. &lt;a href="https://docs.npmjs.com/creating-and-publishing-private-packages">Give a look in this npm article&lt;/a>.&lt;/li>
&lt;/ol></description></item><item><title>A Tale Of How To Not Deploy Two Months Old Features</title><link>https://brunoluiz.net/blog/2018/mar/a-tale-of-how-to-not-deploy-two-months-old-features/</link><pubDate>2018-03-07</pubDate><guid>https://brunoluiz.net/blog/2018/mar/a-tale-of-how-to-not-deploy-two-months-old-features/</guid><description>&lt;p>&lt;img loading="lazy" src="cover.jpg" alt="Photo by rawpixel.com on Unsplash" />
&lt;/p>
&lt;p>There is one big and very special date on the e-commerce and retail market and it&amp;rsquo;s called Black Friday. For many, it means &amp;ldquo;discount prices&amp;rdquo;, &amp;ldquo;sale!&amp;rdquo;, &amp;ldquo;50% off&amp;rdquo;, but for developers and IT people it is a challenging adventure.&lt;/p>
&lt;p>To begin with, two weeks before, feature deployments are frozen and everything passes through load tests. On the week, machines are scaled up and, at the event&amp;rsquo;s day, all eyes are on metrics and logs.&lt;/p>
&lt;p>But there is a catch in this whole story: the feature development can&amp;rsquo;t stop. This means features will begin to stack up soon after the feature deployment freeze and usually it continues a bit after the event, especially when your software is multi-tenant and each client has its own Black Friday agenda.&lt;/p>
&lt;p>In the case which gave this article its title, the deploy was delayed until close Christmas and, as it was Christmas, the team preferred to not deploy until the next year.&lt;/p>
&lt;p>January came by and, at some point, the delayed deploys would have to start. As four sprints have been passed since Black Friday, the usual process would be to deploy each sprint package atomically, monitoring its results in the production environment. But this, this is not an ideal world.&lt;/p>
&lt;p>&lt;img loading="lazy" src="surprises.jpeg" alt="Photo by rawpixel.com on Unsplash" />
&lt;/p>
&lt;h2 id="product-development-life-is-full-of-surprises">Product Development Life Is Full Of Surprises&lt;/h2>
&lt;p>When a product is just in its early days, the first clients are tech early adopters and the development team have to be close to them, as their inputs are valuable.&lt;/p>
&lt;p>At some day in January, one of the major platform&amp;rsquo;s clients informed they would launch more shops on the system. Besides the fact that, usually, some preparation is required, the biggest issue was that a specific feature was required. It had been developed at some point, but it was not well tested yet.&lt;/p>
&lt;p>Even worse, this feature depended on others, implemented in late November and early December, which means &amp;ldquo;Goodbye atomic deploys&amp;rdquo;: the team will have to prepare a deploy package with all four sprint features. Dangerous, isn&amp;rsquo;t it? Remember the &lt;em>challenging adventure&lt;/em> part?&lt;/p>
&lt;p>While finishing and polishing the required feature, the QA team had to work deliberately to test all features again to be sure that everything would be pretty smooth. Even those which were already tested as, since November, some hotfixes were made on the production environment and who knows if they could have affected one of the already tested features.&lt;/p>
&lt;p>With the feature finished, the QA and management teams got together to test it. After a period of tests, they confirmed it was working as expected, with no bugs or business rules flaws. Even though this surprise feature made us work insanely, the deploy looked like it would be a walk in the park.&lt;/p>
&lt;p>&lt;img loading="lazy" src="deploy.jpeg" alt="Photo by SpaceX on Unsplash" />
&lt;/p>
&lt;h2 id="deploy-day">D(eploy)-Day&lt;/h2>
&lt;p>It was 2 am when the whole deploy started. Low traffic and not that many orders flooding the system made it the perfect time to deploy the application. While deploying it, everything seemed fine, even though minor adjustments and migrations were needed. As soon as the clock hit 3h30 am, the team members were already wishing &amp;ldquo;Good Night&amp;rdquo; to each other.&lt;/p>
&lt;p>For a package with a lot of features and one quite critical, it was quite smoothâ€¦ and this is when things started to fall apart. At 4 pm, one of the clients started to complain about some orders not being registered due to HTTP 400 errors and some inventory not being updated for no reason. &lt;em>&amp;ldquo;WHAT THE F&lt;/em>CK IS GOING ON!&amp;rdquo; *everybody said, in despair.&lt;/p>
&lt;p>All developers stopped to investigate the problem and, of course, hidden in the middle of one of the sprint release packages, there were two bugs: one related to how the application dealt with the inventory queue producer and the other related to how addresses were validated. Ten lines of code worth of trouble.&lt;/p>
&lt;p>After roughly one hour of stress, everything was calm again, but the results of this deploy changed the entire team.&lt;/p>
&lt;p>&lt;img loading="lazy" src="postmortem.jpeg" alt="Photo by Dustin Lee on Unsplash" />
&lt;/p>
&lt;h2 id="that-post-mortem-and-its-results">THAT Post-Mortem And Its Results&lt;/h2>
&lt;p>Soon after, a post-mortem had been written. Everybody collaborated: developers, managers, and QAs. The information contained in this single document would allow the team to learn, grow and know better how to deal with problems like this in the future.&lt;/p>
&lt;p>At the other day, a morning meeting was scheduled to discuss the points written in the post-mortem. Besides the issues from the deploy itself, many other problems arose in the heat of the discussion. All members agreed on the pointed issues and suggested some actions to tackle them.&lt;/p>
&lt;h3 id="deploy-age">Deploy age&lt;/h3>
&lt;p>One could point to the code and say it was a bug, but it was not only that. Deploys that are too many weeks old are a problem, as it has features developed way too long ago, where devs and testers probably don&amp;rsquo;t remember all specifics for these. This can lead to database issues (if a migration was forgotten), schema validation problems, business rules flaws, and so on.&lt;/p>
&lt;p>The best way to tackle this is to deploy the feature package not too long after the sprint has been finished. Everything will be fresh for all team members and no git gimmicks will be required for this (rebase hell mostly).&lt;/p>
&lt;h3 id="rushed-deploys">Rushed deploys&lt;/h3>
&lt;p>Never do rush deploys, especially big ones. The team will get stressed, communication probably will not be the best, documents (such as the release notes) can have errors or miss information. In this deploy, one of the features was not specified on the JIRA Release Board, but it was on the GitHub release. A developer with more time would have noticed that some stuff was missing.&lt;/p>
&lt;p>These release notes usually will not only be used by the clients, but by the QAs as well, as it will have which features will be deployed. As these have impacts on everybody, the best thing to do is to have a consensus on what can be fully delivered (developer side) and well tested (QA side). The idea is to avoid features which can have bugs or not well tested because they were made in a rush.&lt;/p>
&lt;h3 id="create-processes">Create Processes&lt;/h3>
&lt;p>Usually, people love to complain about &amp;ldquo;processes&amp;rdquo;. Some people even say they love startups because of the lack of them. But they exist for a reason and, in this case, it would have helped if everything followed a well-defined process.&lt;/p>
&lt;p>There was already a process, but it was not that specific. After the incident, the team got together and wrote a document describing each step of the product feature development, with a pipe of what should be done on each step of it: feature discussions and development, peer reviews metrics, deploy and release notes for tests environments, test processes and finally, the production deploy.&lt;/p>
&lt;p>Is it more bureaucratic? For sure! But until now, there were no complains by the team members and, especially, the client.&lt;/p>
&lt;h3 id="more-automated-tests">More Automated Tests&lt;/h3>
&lt;p>Each sprint feature package is tested by QAs in a staging environment. The best scenario is to have a lot of different automated test scenarios, which would give 100% guarantee that nothing will break the APIs.&lt;/p>
&lt;p>But, this isn&amp;rsquo;t a perfect world. The usual is to have part of it automated and part of it is tested by humans. But, as this aging deploy was urgent and made in a rush, some features passed through without being well tested.&lt;/p>
&lt;p>How to solve this problem? Well, one side of the problem is organization: a board tool would help with this but, as aging deploys such as this one have too many tasks, the best thing to do is organize THAT release note. The QA team will be able then to plan how to do its tests.&lt;/p>
&lt;p>The other side, which is a bit more complicated, is to create more automated tests. Not only QAs but developers as well. Everybody knows someone who wants to skip the test development, but this can help to avoid countless problems (especially in the future). The other developers should not allow a feature to go on without automated tests for it. The same applies for QAs.&lt;/p>
&lt;h3 id="error-metrics-monitoring-and-alerts">Error Metrics Monitoring and Alerts&lt;/h3>
&lt;p>Soon after the deploy, the team has checked some error metrics on &lt;a href="https://www.graylog.org">Graylog&lt;/a> and &lt;a href="https://aws.amazon.com/cloudwatch/">CloudWatch&lt;/a>, but these error metrics were just for a part of the system, not its whole. If more metrics had been monitored, probably the problem would have been discovered way before and the impact would have been smaller.&lt;/p>
&lt;p>The team should monitor at least some of these metrics manually, through dashboards or even the application log, but the best way to tackle this is through automated alerts. Nowadays, all major IaaS providers have a service for metrics and logs. With CloudWatch (AWS), the team can set alerts for when too many error HTTP responses are given by the applications on a certain determined period. It can send e-mails, SMS and even be integrated with mobile apps such as &lt;a href="https://www.opsgenie.com/">OpsGenie&lt;/a>.&lt;/p>
&lt;p>There are other tools besides these, such as &lt;a href="https://newrelic.com/">NewRelic&lt;/a> and &lt;a href="https://www.librato.com/">Librato&lt;/a>, but they are a bit more specific and the team should analyze if they are really required.&lt;/p>
&lt;p>&lt;img loading="lazy" src="noproblems.jpeg" alt="Photo by Kupono Kuwamura on Unsplash" />
&lt;/p>
&lt;h2 id="end-of-problems">End Of Problems?&lt;/h2>
&lt;p>This will not be the last problem the team will have to struggle with. Stressful moments like these will appear but this is when the team will learn and grow, being able to rise and aim towards high stakes through time.&lt;/p></description></item><item><title>Joi: validate input and define databases in JavaScript</title><link>https://brunoluiz.net/blog/2017/aug/joi-validate-input-and-define-databases-in-javascript/</link><pubDate>2017-08-30</pubDate><guid>https://brunoluiz.net/blog/2017/aug/joi-validate-input-and-define-databases-in-javascript/</guid><description>&lt;p>&lt;img loading="lazy" src="cover.jpg" alt="Photo by Rayi Christian Wicaksono" />
&lt;/p>
&lt;p>As the saying goes: &lt;em>never trust user input&lt;/em>. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi.&lt;/p>
&lt;p>&lt;a href="https://github.com/hapijs/joi">Joi&lt;/a> is maintained by &lt;a href="https://hapijs.com/">Hapi.js project&lt;/a>. Even though hapi.js is a web framework by itself, Joi is independent and can be used in any type of node project. This is great for people using express or restify, for example.&lt;/p>
&lt;p>What makes it even more interesting is that, besides user validation, it can be used to define database schemas as well. This post will introduce a quick start guide, with some usage cases and general tweaks.&lt;/p>
&lt;h2 id="how-to-use-it">How to use it?&lt;/h2>
&lt;p>First things first: it has to be installed on the project. Considering an already initiated node project, the command to install it is: npm install joi. After being installed, a schema is required to use it, such as the file &lt;code>rating-schema.js&lt;/code> below:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// rating-schema.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;joi&amp;#39;&lt;/span>)
&lt;span style="color:#a6e22e">module&lt;/span>.&lt;span style="color:#a6e22e">exports&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">object&lt;/span>().&lt;span style="color:#a6e22e">keys&lt;/span>({
&lt;span style="color:#a6e22e">username&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">string&lt;/span>(),
&lt;span style="color:#a6e22e">rating&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">number&lt;/span>()
.&lt;span style="color:#a6e22e">integer&lt;/span>()
.&lt;span style="color:#a6e22e">min&lt;/span>(&lt;span style="color:#ae81ff">1&lt;/span>)
.&lt;span style="color:#a6e22e">max&lt;/span>(&lt;span style="color:#ae81ff">5&lt;/span>)
.&lt;span style="color:#66d9ef">default&lt;/span>(&lt;span style="color:#ae81ff">5&lt;/span>),
&lt;span style="color:#a6e22e">email&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">string&lt;/span>()
.&lt;span style="color:#a6e22e">email&lt;/span>()
.&lt;span style="color:#a6e22e">required&lt;/span>()
})
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This defines a model where an username, a rating (from 1 to 5) and an email (which is a required field) are expected. This is a simple example, but there are way more validation options, which can be found on the &lt;a href="https://github.com/hapijs/joi/blob/v10.6.0/API.md">API reference&lt;/a>. To use the defined schema, consider a file called &lt;code>rating-test.js&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// rating-test.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">schema&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;./rating-schema&amp;#39;&lt;/span>)
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">result&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">schema&lt;/span>.&lt;span style="color:#a6e22e">validate&lt;/span>({
&lt;span style="color:#a6e22e">username&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;brunoluiz&amp;#39;&lt;/span>,
&lt;span style="color:#a6e22e">rating&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>,
&lt;span style="color:#a6e22e">email&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;contact@brunoluiz.net&amp;#39;&lt;/span>
})
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">result&lt;/span>) &lt;span style="color:#75715e">// result.error will be null
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#75715e">// result.error will show an error due to missing e-mail
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">resultWithError&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">schema&lt;/span>.&lt;span style="color:#a6e22e">validate&lt;/span>({
&lt;span style="color:#a6e22e">username&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;brunoluiz&amp;#39;&lt;/span>,
&lt;span style="color:#a6e22e">rating&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>
})
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">resultWithError&lt;/span>) &lt;span style="color:#75715e">// result.error will have an error message
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a href="https://github.com/hapijs/joi/blob/v10.6.0/API.md#errors">More about Joi errors&lt;/a>&lt;/p>
&lt;h2 id="real-project-usage">Real project usage&lt;/h2>
&lt;h3 id="validation-middleware">Validation middleware&lt;/h3>
&lt;p>In a real project, Joi can be used on a middleware layer. On &lt;a href="http://expressjs.com">&lt;code>express&lt;/code>&lt;/a>, for example, this can be done using:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// ratings-validor.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#a6e22e">module&lt;/span>.&lt;span style="color:#a6e22e">exports&lt;/span> &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>) =&amp;gt; {
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">ratings&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Ratings&lt;/span>.&lt;span style="color:#a6e22e">schema&lt;/span>.&lt;span style="color:#a6e22e">validate&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">ratings&lt;/span>.&lt;span style="color:#a6e22e">error&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">next&lt;/span>(&lt;span style="color:#a6e22e">ratings&lt;/span>.&lt;span style="color:#a6e22e">error&lt;/span>)
}
&lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">parsed&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ratings&lt;/span>.&lt;span style="color:#a6e22e">value&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">next&lt;/span>()
}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// ....
&lt;/span>&lt;span style="color:#75715e">// routes.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#a6e22e">app&lt;/span>.&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/ratings&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">ratingsValidator&lt;/span>, &lt;span style="color:#a6e22e">ratingsCreateController&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this case, if the &lt;code>ratingsValidator&lt;/code> returns an error due to validation, express will stop the request before even reaching the controller.&lt;/p>
&lt;h3 id="database-schema-mongodb-and-dynamodb">Database schema (MongoDB and DynamoDB)&lt;/h3>
&lt;p>Some tools can use it to define their database schema (keep in mind that Joi is not an ORM). For MongoDB, &lt;code>mongoose&lt;/code> can be used together with &lt;a href="https://github.com/yoitsro/joigoose">&lt;code>joigoose&lt;/code>&lt;/a>, which easily converts a Joi schema. For example:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// rating.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">mongoose&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;mongoose&amp;#39;&lt;/span>)
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">joigoose&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;joigoose&amp;#39;&lt;/span>)(&lt;span style="color:#a6e22e">mongoose&lt;/span>)
&lt;span style="color:#75715e">// Require the &amp;#39;ratings&amp;#39; schema
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">schema&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;./rating-schema&amp;#39;&lt;/span>)
&lt;span style="color:#75715e">// Convert joi to mongoose schema
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">mongooseSchema&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">joigoose&lt;/span>.&lt;span style="color:#a6e22e">convert&lt;/span>(&lt;span style="color:#a6e22e">schema&lt;/span>)
&lt;span style="color:#75715e">// Modify some fields with database specific instructions
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">mongooseSchema&lt;/span>.&lt;span style="color:#a6e22e">email&lt;/span>.&lt;span style="color:#a6e22e">unique&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>
&lt;span style="color:#75715e">// Add fields which don&amp;#39;t make sense on the schema validator
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">mongooseSchema&lt;/span>.&lt;span style="color:#a6e22e">updatedAt&lt;/span> &lt;span style="color:#f92672">=&lt;/span> { &lt;span style="color:#a6e22e">type&lt;/span>&lt;span style="color:#f92672">:&lt;/span> Date, &lt;span style="color:#66d9ef">default&lt;/span>&lt;span style="color:#f92672">:&lt;/span> Date.&lt;span style="color:#a6e22e">now&lt;/span> }
&lt;span style="color:#a6e22e">mongooseSchema&lt;/span>.&lt;span style="color:#a6e22e">createdAt&lt;/span> &lt;span style="color:#f92672">=&lt;/span> { &lt;span style="color:#a6e22e">type&lt;/span>&lt;span style="color:#f92672">:&lt;/span> Date, &lt;span style="color:#66d9ef">default&lt;/span>&lt;span style="color:#f92672">:&lt;/span> Date.&lt;span style="color:#a6e22e">now&lt;/span> }
&lt;span style="color:#75715e">// Define mongoose model
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">Ratings&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">mongoose&lt;/span>.&lt;span style="color:#a6e22e">model&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Ratings&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">mongooseSchema&lt;/span>)
&lt;span style="color:#a6e22e">module&lt;/span>.&lt;span style="color:#a6e22e">exports&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Ratings&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Through &lt;a href="https://github.com/ryanfitz/vogels">&lt;code>vogels&lt;/code>&lt;/a>, the same can be done in projects using DynamoDB. By default, it accepts Joi as its schema definition. The following example is based on &lt;code>vogels&lt;/code> documentation:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// blog-post-schema.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#a6e22e">module&lt;/span>.&lt;span style="color:#a6e22e">exports&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {
&lt;span style="color:#a6e22e">email&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">string&lt;/span>().&lt;span style="color:#a6e22e">email&lt;/span>(),
&lt;span style="color:#a6e22e">title&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">string&lt;/span>(),
&lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">binary&lt;/span>(),
&lt;span style="color:#a6e22e">tags&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">vogels&lt;/span>.&lt;span style="color:#a6e22e">types&lt;/span>.&lt;span style="color:#a6e22e">stringSet&lt;/span>()
}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// blog-post.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">schema&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;./blog-post-schema.js&amp;#39;&lt;/span>)
&lt;span style="color:#a6e22e">module&lt;/span>.&lt;span style="color:#a6e22e">exports&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">vogels&lt;/span>.&lt;span style="color:#a6e22e">define&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;BlogPost&amp;#39;&lt;/span>, {
&lt;span style="color:#a6e22e">hashKey&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;email&amp;#39;&lt;/span>,
&lt;span style="color:#a6e22e">rangeKey&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">â€˜&lt;/span>&lt;span style="color:#a6e22e">title&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">â€™&lt;/span>,
&lt;span style="color:#a6e22e">schema&lt;/span>
})
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="exchangeability-for-front-end-validation">Exchangeability for front-end validation&lt;/h3>
&lt;p>Some developers prefer to define the schema once and then use everywhere, including on browsers. Today &lt;a href="https://github.com/hapijs/joi/#browsers">Joi doesn&amp;rsquo;t support browser usage&lt;/a>, but a package called &lt;a href="https://github.com/jeffbski/joi-browser">&lt;code>joi-browser&lt;/code> does this job&lt;/a>, enabling the usage of exactly the same schema on the front-end as well.&lt;/p>
&lt;h2 id="useful-tweaks">Useful tweaks&lt;/h2>
&lt;p>&lt;img loading="lazy" src="tweaking.jpeg" alt="Photo by chuttersnap on Unsplash" />
&lt;/p>
&lt;h3 id="1-disable-joi-number-convert">#1 Disable Joi number() convert&lt;/h3>
&lt;p>By default, Joi allows users to pass numbers formatted as strings, in cases of number() fields. This is specially bad if the validate() result is only used to check if there was an error, but not for it&amp;rsquo;s value field. To solve this, there are two possible solutions&lt;/p>
&lt;ol>
&lt;li>
&lt;p>On &lt;code>schema.validate(value)&lt;/code>, an extra parameter can be passed to disable it, as: &lt;code>schema.validate(value, { convert: false })&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Put a &lt;code>strict()&lt;/code> at the end of the desired number field, as: &lt;code>Joi.number().strict()&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>Both of them are quite annoying, because either all fields or all function calls require a specific config. One way to solve this is by extending Joiâ€¦&lt;/p>
&lt;h3 id="2-extend-joi-defaults">#2 Extend Joi defaults&lt;/h3>
&lt;p>In cases such as the above, or for new field types, or even when the behavior of a default field has to be changed, &lt;code>Joi.extend()&lt;/code> can be an option.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// joi.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;joi&amp;#39;&lt;/span>)
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">ukzip&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">/^[A-Z]{1,2}[0-9]{1,2}[A-Z]{0,1} ?[0-9][A-Z]{2}$/i&lt;/span>
&lt;span style="color:#a6e22e">module&lt;/span>.&lt;span style="color:#a6e22e">exports&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">extend&lt;/span>(
{
&lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;number&amp;#39;&lt;/span>,
&lt;span style="color:#a6e22e">base&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">number&lt;/span>().&lt;span style="color:#a6e22e">strict&lt;/span>()
},
{
&lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;zipcode&amp;#39;&lt;/span>,
&lt;span style="color:#a6e22e">base&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">regex&lt;/span>(&lt;span style="color:#a6e22e">ukzip&lt;/span>).&lt;span style="color:#a6e22e">description&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;UK Zipcode&amp;#39;&lt;/span>)
}
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>When using Joi through this file, all number fields will be on the strict mode â€” which solves the issue of applying tweak #1 everywhere â€” and a &lt;code>zipcode()&lt;/code> validator is created, based on a pre-defined regex.&lt;/p>
&lt;p>More rules can be added and, actually, the Joi API enables &lt;a href="https://github.com/hapijs/joi/blob/v10.6.0/API.md#extendextension">much more customisation&lt;/a> on &lt;code>Joi.extend&lt;/code>.&lt;/p>
&lt;h3 id="3-create-default-fields">#3 Create default fields&lt;/h3>
&lt;p>In some projects, a lot of models will have some default fields, such as an &lt;code>extensionAttributes&lt;/code>, where custom vendor data will be put into (as Magento already does) or &lt;code>updatedAt&lt;/code>. In these cases, the &lt;code>Joi.object&lt;/code> can be extended to include default fields:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// joi.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;joi&amp;#39;&lt;/span>)
&lt;span style="color:#a6e22e">module&lt;/span>.&lt;span style="color:#a6e22e">exports&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">extend&lt;/span>({
&lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;object&amp;#39;&lt;/span>,
&lt;span style="color:#a6e22e">base&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">object&lt;/span>().&lt;span style="color:#a6e22e">keys&lt;/span>({
&lt;span style="color:#a6e22e">extensionAttributes&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">object&lt;/span>(),
&lt;span style="color:#a6e22e">updatedAt&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">date&lt;/span>().&lt;span style="color:#66d9ef">default&lt;/span>(Date.&lt;span style="color:#a6e22e">now&lt;/span>)
})
})
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="4-show-all-validation-errors">#4 Show all validation errors&lt;/h3>
&lt;p>Usually Joi validation dies on the first error, returning on it&amp;rsquo;s message which field failed. This is an issue when an input have many fields with problems. The user will have to do many requests to discover all problematic fields. To fix this issue, the following option can be added on the function call:&lt;/p>
&lt;p>&lt;code>const result = schema.validate(value, { abortEarly: false })&lt;/code>&lt;/p>
&lt;p>With this config, if an error occurs, the &lt;code>result.error&lt;/code> will return all validation failures.&lt;/p>
&lt;h3 id="5-built-in-joi-conditional-validations">#5 Built-in Joi conditional validations&lt;/h3>
&lt;p>If a field depends on values from another field, the conditional when() can be used.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">// joi-from-doc.js
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;joi&amp;#39;&lt;/span>)
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">schema&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">object&lt;/span>().&lt;span style="color:#a6e22e">keys&lt;/span>({
&lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">any&lt;/span>()
.&lt;span style="color:#a6e22e">valid&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;x&amp;#39;&lt;/span>)
.&lt;span style="color:#a6e22e">when&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;b&amp;#39;&lt;/span>, {
&lt;span style="color:#a6e22e">is&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>,
&lt;span style="color:#a6e22e">then&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">valid&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;y&amp;#39;&lt;/span>),
&lt;span style="color:#a6e22e">otherwise&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">valid&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;z&amp;#39;&lt;/span>)
}),
&lt;span style="color:#a6e22e">b&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">Joi&lt;/span>.&lt;span style="color:#a6e22e">any&lt;/span>()
})
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">schema&lt;/span>.&lt;span style="color:#a6e22e">validate&lt;/span>({ &lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;x&amp;#39;&lt;/span> }).&lt;span style="color:#a6e22e">error&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) &lt;span style="color:#75715e">// valid
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">schema&lt;/span>.&lt;span style="color:#a6e22e">validate&lt;/span>({ &lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;z&amp;#39;&lt;/span> }).&lt;span style="color:#a6e22e">error&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) &lt;span style="color:#75715e">// valid
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">schema&lt;/span>.&lt;span style="color:#a6e22e">validate&lt;/span>({ &lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;z&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">b&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> }).&lt;span style="color:#a6e22e">error&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) &lt;span style="color:#75715e">// valid
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">schema&lt;/span>.&lt;span style="color:#a6e22e">validate&lt;/span>({ &lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;y&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">b&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> }).&lt;span style="color:#a6e22e">error&lt;/span> &lt;span style="color:#f92672">!==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) &lt;span style="color:#75715e">// invalid
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#a6e22e">schema&lt;/span>.&lt;span style="color:#a6e22e">validate&lt;/span>({ &lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;y&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">b&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> }).&lt;span style="color:#a6e22e">error&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) &lt;span style="color:#75715e">// valid
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this case, the field &lt;code>a&lt;/code> accepts the values &lt;code>x, y, z&lt;/code>. But, to accept &lt;code>y&lt;/code> as a value, the field b have to be equals 5, otherwise only &lt;code>x&lt;/code> and &lt;code>z&lt;/code> will be accepted.&lt;/p>
&lt;p>Of course, this is a simple and fictitious conditional validation, but it is quite useful in cases where some field requires a specific validator when some other had a specific input.&lt;/p>
&lt;h2 id="are-you-ready-to-use-it">Are you ready to use it?&lt;/h2>
&lt;p>I hope this post convinced you to use some validation tool such as Joi, instead of validating everything by hand (or not validating at all). But, if you are using it already: do you know any other cool trick or tweak? Let me know in the comments section below.&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>Joi repo: &lt;a href="https://github.com/hapijs/joi">https://github.com/hapijs/joi&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Joi API Reference: &lt;a href="https://github.com/hapijs/joi/blob/v10.6.0/API.md">https://github.com/hapijs/joi/blob/v10.6.0/API.md&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Joigoose repo: &lt;a href="https://github.com/yoitsro/joigoose">https://github.com/yoitsro/joigoose&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Joi-browser repo: &lt;a href="https://github.com/jeffbski/joi-browser">https://github.com/jeffbski/joi-browser&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Mongoose website: &lt;a href="http://mongoosejs.com">http://mongoosejs.com&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Vogels repo: &lt;a href="https://github.com/ryanfitz/vogels">https://github.com/ryanfitz/vogels&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></description></item></channel></rss>