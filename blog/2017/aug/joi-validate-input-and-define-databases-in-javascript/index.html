<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Joi: validate input and define databases in JavaScript | Bruno Luiz Silva</title><meta name=keywords content><meta name=description content="As the saying goes: never trust user input. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi."><meta name=author content><link rel=canonical href=https://brunoluiz.net/blog/2017/aug/joi-validate-input-and-define-databases-in-javascript/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://brunoluiz.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://brunoluiz.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://brunoluiz.net/favicon-32x32.png><link rel=apple-touch-icon href=https://brunoluiz.net/apple-touch-icon.png><link rel=mask-icon href=https://brunoluiz.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://brunoluiz.net/blog/2017/aug/joi-validate-input-and-define-databases-in-javascript/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://brunoluiz.net/blog/2017/aug/joi-validate-input-and-define-databases-in-javascript/"><meta property="og:site_name" content="Bruno Luiz Silva"><meta property="og:title" content="Joi: validate input and define databases in JavaScript"><meta property="og:description" content="As the saying goes: never trust user input. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-08-30T19:44:37+00:00"><meta property="article:modified_time" content="2017-08-30T19:44:37+00:00"><meta property="og:image" content="https://brunoluiz.net/cover.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://brunoluiz.net/cover.jpg"><meta name=twitter:title content="Joi: validate input and define databases in JavaScript"><meta name=twitter:description content="As the saying goes: never trust user input. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://brunoluiz.net/blog/"},{"@type":"ListItem","position":2,"name":"Joi: validate input and define databases in JavaScript","item":"https://brunoluiz.net/blog/2017/aug/joi-validate-input-and-define-databases-in-javascript/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Joi: validate input and define databases in JavaScript","name":"Joi: validate input and define databases in JavaScript","description":"As the saying goes: never trust user input. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi.","keywords":[],"articleBody":"As the saying goes: never trust user input. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi.\nJoi is maintained by Hapi.js project. Even though hapi.js is a web framework by itself, Joi is independent and can be used in any type of node project. This is great for people using express or restify, for example.\nWhat makes it even more interesting is that, besides user validation, it can be used to define database schemas as well. This post will introduce a quick start guide, with some usage cases and general tweaks.\nHow to use it? First things first: it has to be installed on the project. Considering an already initiated node project, the command to install it is: npm install joi. After being installed, a schema is required to use it, such as the file rating-schema.js below:\n// rating-schema.js const Joi = require('joi') module.exports = Joi.object().keys({ username: Joi.string(), rating: Joi.number() .integer() .min(1) .max(5) .default(5), email: Joi.string() .email() .required() }) This defines a model where an username, a rating (from 1 to 5) and an email (which is a required field) are expected. This is a simple example, but there are way more validation options, which can be found on the API reference. To use the defined schema, consider a file called rating-test.js:\n// rating-test.js const schema = require('./rating-schema') const result = schema.validate({ username: 'brunoluiz', rating: 5, email: 'contact@brunoluiz.net' }) console.log(result) // result.error will be null // result.error will show an error due to missing e-mail const resultWithError = schema.validate({ username: 'brunoluiz', rating: 5 }) console.log(resultWithError) // result.error will have an error message More about Joi errors\nReal project usage Validation middleware In a real project, Joi can be used on a middleware layer. On express, for example, this can be done using:\n// ratings-validor.js module.exports = (req, res, next) =\u003e { const ratings = Ratings.schema.validate(req.body) if (ratings.error) { return next(ratings.error) } req.parsed = ratings.value return next() } // .... // routes.js app.post('/ratings', ratingsValidator, ratingsCreateController) In this case, if the ratingsValidator returns an error due to validation, express will stop the request before even reaching the controller.\nDatabase schema (MongoDB and DynamoDB) Some tools can use it to define their database schema (keep in mind that Joi is not an ORM). For MongoDB, mongoose can be used together with joigoose, which easily converts a Joi schema. For example:\n// rating.js const mongoose = require('mongoose') const joigoose = require('joigoose')(mongoose) // Require the 'ratings' schema const schema = require('./rating-schema') // Convert joi to mongoose schema const mongooseSchema = joigoose.convert(schema) // Modify some fields with database specific instructions mongooseSchema.email.unique = true // Add fields which don't make sense on the schema validator mongooseSchema.updatedAt = { type: Date, default: Date.now } mongooseSchema.createdAt = { type: Date, default: Date.now } // Define mongoose model const Ratings = mongoose.model('Ratings', mongooseSchema) module.exports = Ratings Through vogels, the same can be done in projects using DynamoDB. By default, it accepts Joi as its schema definition. The following example is based on vogels documentation:\n// blog-post-schema.js module.exports = { email: Joi.string().email(), title: Joi.string(), content: Joi.binary(), tags: vogels.types.stringSet() } // blog-post.js const schema = require('./blog-post-schema.js') module.exports = vogels.define('BlogPost', { hashKey: 'email', rangeKey: ‘title’, schema }) Exchangeability for front-end validation Some developers prefer to define the schema once and then use everywhere, including on browsers. Today Joi doesn’t support browser usage, but a package called joi-browser does this job, enabling the usage of exactly the same schema on the front-end as well.\nUseful tweaks #1 Disable Joi number() convert By default, Joi allows users to pass numbers formatted as strings, in cases of number() fields. This is specially bad if the validate() result is only used to check if there was an error, but not for it’s value field. To solve this, there are two possible solutions\nOn schema.validate(value), an extra parameter can be passed to disable it, as: schema.validate(value, { convert: false })\nPut a strict() at the end of the desired number field, as: Joi.number().strict()\nBoth of them are quite annoying, because either all fields or all function calls require a specific config. One way to solve this is by extending Joi…\n#2 Extend Joi defaults In cases such as the above, or for new field types, or even when the behavior of a default field has to be changed, Joi.extend() can be an option.\n// joi.js const Joi = require('joi') const ukzip = /^[A-Z]{1,2}[0-9]{1,2}[A-Z]{0,1} ?[0-9][A-Z]{2}$/i module.exports = Joi.extend( { name: 'number', base: Joi.number().strict() }, { name: 'zipcode', base: Joi.regex(ukzip).description('UK Zipcode') } ) When using Joi through this file, all number fields will be on the strict mode — which solves the issue of applying tweak #1 everywhere — and a zipcode() validator is created, based on a pre-defined regex.\nMore rules can be added and, actually, the Joi API enables much more customisation on Joi.extend.\n#3 Create default fields In some projects, a lot of models will have some default fields, such as an extensionAttributes, where custom vendor data will be put into (as Magento already does) or updatedAt. In these cases, the Joi.object can be extended to include default fields:\n// joi.js const Joi = require('joi') module.exports = Joi.extend({ name: 'object', base: Joi.object().keys({ extensionAttributes: Joi.object(), updatedAt: Joi.date().default(Date.now) }) }) #4 Show all validation errors Usually Joi validation dies on the first error, returning on it’s message which field failed. This is an issue when an input have many fields with problems. The user will have to do many requests to discover all problematic fields. To fix this issue, the following option can be added on the function call:\nconst result = schema.validate(value, { abortEarly: false })\nWith this config, if an error occurs, the result.error will return all validation failures.\n#5 Built-in Joi conditional validations If a field depends on values from another field, the conditional when() can be used.\n// joi-from-doc.js const Joi = require('joi') const schema = Joi.object().keys({ a: Joi.any() .valid('x') .when('b', { is: 5, then: Joi.valid('y'), otherwise: Joi.valid('z') }), b: Joi.any() }) console.log(schema.validate({ a: 'x' }).error === null) // valid console.log(schema.validate({ a: 'z' }).error === null) // valid console.log(schema.validate({ a: 'z', b: 0 }).error === null) // valid console.log(schema.validate({ a: 'y', b: 0 }).error !== null) // invalid console.log(schema.validate({ a: 'y', b: 5 }).error === null) // valid In this case, the field a accepts the values x, y, z. But, to accept y as a value, the field b have to be equals 5, otherwise only x and z will be accepted.\nOf course, this is a simple and fictitious conditional validation, but it is quite useful in cases where some field requires a specific validator when some other had a specific input.\nAre you ready to use it? I hope this post convinced you to use some validation tool such as Joi, instead of validating everything by hand (or not validating at all). But, if you are using it already: do you know any other cool trick or tweak? Let me know in the comments section below.\nReferences Joi repo: https://github.com/hapijs/joi\nJoi API Reference: https://github.com/hapijs/joi/blob/v10.6.0/API.md\nJoigoose repo: https://github.com/yoitsro/joigoose\nJoi-browser repo: https://github.com/jeffbski/joi-browser\nMongoose website: http://mongoosejs.com\nVogels repo: https://github.com/ryanfitz/vogels\n","wordCount":"1192","inLanguage":"en","image":"https://brunoluiz.net/cover.jpg","datePublished":"2017-08-30T19:44:37.121Z","dateModified":"2017-08-30T19:44:37.121Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://brunoluiz.net/blog/2017/aug/joi-validate-input-and-define-databases-in-javascript/"},"publisher":{"@type":"Organization","name":"Bruno Luiz Silva","logo":{"@type":"ImageObject","url":"https://brunoluiz.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://brunoluiz.net/ accesskey=h title="Bruno Luiz Silva (Alt + H)">Bruno Luiz Silva</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Joi: validate input and define databases in JavaScript</h1><div class=post-meta><span title='2017-08-30 19:44:37.121 +0000 UTC'>August 30, 2017</span>&nbsp;·&nbsp;6 min</div></header><figure class=entry-cover><img loading=eager src=https://brunoluiz.net/cover.jpg alt="Photo by Rayi Christian Wicaksono"><figcaption>Photo by Rayi Christian Wicaksono</figcaption></figure><div class=post-content><p>As the saying goes: <em>never trust user input</em>. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi.</p><p><a href=https://github.com/hapijs/joi>Joi</a> is maintained by <a href=https://hapijs.com/>Hapi.js project</a>. Even though hapi.js is a web framework by itself, Joi is independent and can be used in any type of node project. This is great for people using express or restify, for example.</p><p>What makes it even more interesting is that, besides user validation, it can be used to define database schemas as well. This post will introduce a quick start guide, with some usage cases and general tweaks.</p><h2 id=how-to-use-it>How to use it?<a hidden class=anchor aria-hidden=true href=#how-to-use-it>#</a></h2><p>First things first: it has to be installed on the project. Considering an already initiated node project, the command to install it is: npm install joi. After being installed, a schema is required to use it, such as the file <code>rating-schema.js</code> below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// rating-schema.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Joi</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;joi&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>object</span>().<span style=color:#a6e22e>keys</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>string</span>(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rating</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>number</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>integer</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    .<span style=color:#66d9ef>default</span>(<span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>string</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>email</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>required</span>()
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>This defines a model where an username, a rating (from 1 to 5) and an email (which is a required field) are expected. This is a simple example, but there are way more validation options, which can be found on the <a href=https://github.com/hapijs/joi/blob/v10.6.0/API.md>API reference</a>. To use the defined schema, consider a file called <code>rating-test.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// rating-test.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./rating-schema&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>validate</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;brunoluiz&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rating</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;contact@brunoluiz.net&#39;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>result</span>) <span style=color:#75715e>// result.error will be null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// result.error will show an error due to missing e-mail
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resultWithError</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>validate</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;brunoluiz&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rating</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>resultWithError</span>) <span style=color:#75715e>// result.error will have an error message
</span></span></span></code></pre></div><p><a href=https://github.com/hapijs/joi/blob/v10.6.0/API.md#errors>More about Joi errors</a></p><h2 id=real-project-usage>Real project usage<a hidden class=anchor aria-hidden=true href=#real-project-usage>#</a></h2><h3 id=validation-middleware>Validation middleware<a hidden class=anchor aria-hidden=true href=#validation-middleware>#</a></h3><p>In a real project, Joi can be used on a middleware layer. On <a href=http://expressjs.com><code>express</code></a>, for example, this can be done using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// ratings-validor.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ratings</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Ratings</span>.<span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>validate</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ratings</span>.<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>ratings</span>.<span style=color:#a6e22e>error</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>parsed</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ratings</span>.<span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// ....
</span></span></span><span style=display:flex><span><span style=color:#75715e>// routes.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/ratings&#39;</span>, <span style=color:#a6e22e>ratingsValidator</span>, <span style=color:#a6e22e>ratingsCreateController</span>)
</span></span></code></pre></div><p>In this case, if the <code>ratingsValidator</code> returns an error due to validation, express will stop the request before even reaching the controller.</p><h3 id=database-schema-mongodb-and-dynamodb>Database schema (MongoDB and DynamoDB)<a hidden class=anchor aria-hidden=true href=#database-schema-mongodb-and-dynamodb>#</a></h3><p>Some tools can use it to define their database schema (keep in mind that Joi is not an ORM). For MongoDB, <code>mongoose</code> can be used together with <a href=https://github.com/yoitsro/joigoose><code>joigoose</code></a>, which easily converts a Joi schema. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// rating.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mongoose</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>joigoose</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;joigoose&#39;</span>)(<span style=color:#a6e22e>mongoose</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Require the &#39;ratings&#39; schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./rating-schema&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Convert joi to mongoose schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mongooseSchema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>joigoose</span>.<span style=color:#a6e22e>convert</span>(<span style=color:#a6e22e>schema</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Modify some fields with database specific instructions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>mongooseSchema</span>.<span style=color:#a6e22e>email</span>.<span style=color:#a6e22e>unique</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Add fields which don&#39;t make sense on the schema validator
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>mongooseSchema</span>.<span style=color:#a6e22e>updatedAt</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> Date, <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> Date.<span style=color:#a6e22e>now</span> }
</span></span><span style=display:flex><span><span style=color:#a6e22e>mongooseSchema</span>.<span style=color:#a6e22e>createdAt</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> Date, <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> Date.<span style=color:#a6e22e>now</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Define mongoose model
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Ratings</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;Ratings&#39;</span>, <span style=color:#a6e22e>mongooseSchema</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Ratings</span>
</span></span></code></pre></div><p>Through <a href=https://github.com/ryanfitz/vogels><code>vogels</code></a>, the same can be done in projects using DynamoDB. By default, it accepts Joi as its schema definition. The following example is based on <code>vogels</code> documentation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// blog-post-schema.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>string</span>().<span style=color:#a6e22e>email</span>(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>string</span>(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>binary</span>(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tags</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>vogels</span>.<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>stringSet</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// blog-post.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./blog-post-schema.js&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>vogels</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;BlogPost&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hashKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;email&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rangeKey</span><span style=color:#f92672>:</span> <span style=color:#960050;background-color:#1e0010>‘</span><span style=color:#a6e22e>title</span><span style=color:#960050;background-color:#1e0010>’</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>schema</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h3 id=exchangeability-for-front-end-validation>Exchangeability for front-end validation<a hidden class=anchor aria-hidden=true href=#exchangeability-for-front-end-validation>#</a></h3><p>Some developers prefer to define the schema once and then use everywhere, including on browsers. Today <a href=https://github.com/hapijs/joi/#browsers>Joi doesn&rsquo;t support browser usage</a>, but a package called <a href=https://github.com/jeffbski/joi-browser><code>joi-browser</code> does this job</a>, enabling the usage of exactly the same schema on the front-end as well.</p><h2 id=useful-tweaks>Useful tweaks<a hidden class=anchor aria-hidden=true href=#useful-tweaks>#</a></h2><p><img alt="Photo by chuttersnap on Unsplash" loading=lazy src=/blog/2017/aug/joi-validate-input-and-define-databases-in-javascript/tweaking.jpeg></p><h3 id=1-disable-joi-number-convert>#1 Disable Joi number() convert<a hidden class=anchor aria-hidden=true href=#1-disable-joi-number-convert>#</a></h3><p>By default, Joi allows users to pass numbers formatted as strings, in cases of number() fields. This is specially bad if the validate() result is only used to check if there was an error, but not for it&rsquo;s value field. To solve this, there are two possible solutions</p><ol><li><p>On <code>schema.validate(value)</code>, an extra parameter can be passed to disable it, as: <code>schema.validate(value, { convert: false })</code></p></li><li><p>Put a <code>strict()</code> at the end of the desired number field, as: <code>Joi.number().strict()</code></p></li></ol><p>Both of them are quite annoying, because either all fields or all function calls require a specific config. One way to solve this is by extending Joi…</p><h3 id=2-extend-joi-defaults>#2 Extend Joi defaults<a hidden class=anchor aria-hidden=true href=#2-extend-joi-defaults>#</a></h3><p>In cases such as the above, or for new field types, or even when the behavior of a default field has to be changed, <code>Joi.extend()</code> can be an option.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// joi.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Joi</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;joi&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ukzip</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/^[A-Z]{1,2}[0-9]{1,2}[A-Z]{0,1} ?[0-9][A-Z]{2}$/i</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>extend</span>(
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;number&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>base</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>number</span>().<span style=color:#a6e22e>strict</span>()
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;zipcode&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>base</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>regex</span>(<span style=color:#a6e22e>ukzip</span>).<span style=color:#a6e22e>description</span>(<span style=color:#e6db74>&#39;UK Zipcode&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>When using Joi through this file, all number fields will be on the strict mode — which solves the issue of applying tweak #1 everywhere — and a <code>zipcode()</code> validator is created, based on a pre-defined regex.</p><p>More rules can be added and, actually, the Joi API enables <a href=https://github.com/hapijs/joi/blob/v10.6.0/API.md#extendextension>much more customisation</a> on <code>Joi.extend</code>.</p><h3 id=3-create-default-fields>#3 Create default fields<a hidden class=anchor aria-hidden=true href=#3-create-default-fields>#</a></h3><p>In some projects, a lot of models will have some default fields, such as an <code>extensionAttributes</code>, where custom vendor data will be put into (as Magento already does) or <code>updatedAt</code>. In these cases, the <code>Joi.object</code> can be extended to include default fields:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// joi.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Joi</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;joi&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>extend</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;object&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>base</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>object</span>().<span style=color:#a6e22e>keys</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>extensionAttributes</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>object</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updatedAt</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>date</span>().<span style=color:#66d9ef>default</span>(Date.<span style=color:#a6e22e>now</span>)
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h3 id=4-show-all-validation-errors>#4 Show all validation errors<a hidden class=anchor aria-hidden=true href=#4-show-all-validation-errors>#</a></h3><p>Usually Joi validation dies on the first error, returning on it&rsquo;s message which field failed. This is an issue when an input have many fields with problems. The user will have to do many requests to discover all problematic fields. To fix this issue, the following option can be added on the function call:</p><p><code>const result = schema.validate(value, { abortEarly: false })</code></p><p>With this config, if an error occurs, the <code>result.error</code> will return all validation failures.</p><h3 id=5-built-in-joi-conditional-validations>#5 Built-in Joi conditional validations<a hidden class=anchor aria-hidden=true href=#5-built-in-joi-conditional-validations>#</a></h3><p>If a field depends on values from another field, the conditional when() can be used.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// joi-from-doc.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Joi</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;joi&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>object</span>().<span style=color:#a6e22e>keys</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>any</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>valid</span>(<span style=color:#e6db74>&#39;x&#39;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>when</span>(<span style=color:#e6db74>&#39;b&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>is</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>valid</span>(<span style=color:#e6db74>&#39;y&#39;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>otherwise</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>valid</span>(<span style=color:#e6db74>&#39;z&#39;</span>)
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>b</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Joi</span>.<span style=color:#a6e22e>any</span>()
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>validate</span>({ <span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;x&#39;</span> }).<span style=color:#a6e22e>error</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) <span style=color:#75715e>// valid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>validate</span>({ <span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;z&#39;</span> }).<span style=color:#a6e22e>error</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) <span style=color:#75715e>// valid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>validate</span>({ <span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;z&#39;</span>, <span style=color:#a6e22e>b</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span> }).<span style=color:#a6e22e>error</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) <span style=color:#75715e>// valid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>validate</span>({ <span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;y&#39;</span>, <span style=color:#a6e22e>b</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span> }).<span style=color:#a6e22e>error</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) <span style=color:#75715e>// invalid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>validate</span>({ <span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;y&#39;</span>, <span style=color:#a6e22e>b</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span> }).<span style=color:#a6e22e>error</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) <span style=color:#75715e>// valid
</span></span></span></code></pre></div><p>In this case, the field <code>a</code> accepts the values <code>x, y, z</code>. But, to accept <code>y</code> as a value, the field b have to be equals 5, otherwise only <code>x</code> and <code>z</code> will be accepted.</p><p>Of course, this is a simple and fictitious conditional validation, but it is quite useful in cases where some field requires a specific validator when some other had a specific input.</p><h2 id=are-you-ready-to-use-it>Are you ready to use it?<a hidden class=anchor aria-hidden=true href=#are-you-ready-to-use-it>#</a></h2><p>I hope this post convinced you to use some validation tool such as Joi, instead of validating everything by hand (or not validating at all). But, if you are using it already: do you know any other cool trick or tweak? Let me know in the comments section below.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><p>Joi repo: <a href=https://github.com/hapijs/joi>https://github.com/hapijs/joi</a></p></li><li><p>Joi API Reference: <a href=https://github.com/hapijs/joi/blob/v10.6.0/API.md>https://github.com/hapijs/joi/blob/v10.6.0/API.md</a></p></li><li><p>Joigoose repo: <a href=https://github.com/yoitsro/joigoose>https://github.com/yoitsro/joigoose</a></p></li><li><p>Joi-browser repo: <a href=https://github.com/jeffbski/joi-browser>https://github.com/jeffbski/joi-browser</a></p></li><li><p>Mongoose website: <a href=http://mongoosejs.com>http://mongoosejs.com</a></p></li><li><p>Vogels repo: <a href=https://github.com/ryanfitz/vogels>https://github.com/ryanfitz/vogels</a></p></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://brunoluiz.net/blog/2018/mar/a-tale-of-how-to-not-deploy-two-months-old-features/><span class=title>« Prev</span><br><span>A Tale Of How To Not Deploy Two Months Old Features</span>
</a><a class=next href=https://brunoluiz.net/blog/2017/jul/still-using-gitflow-what-about-a-simpler-alternative/><span class=title>Next »</span><br><span>Still using GitFlow? What about a simpler alternative?</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://brunoluiz.net/>Bruno Luiz Silva</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>